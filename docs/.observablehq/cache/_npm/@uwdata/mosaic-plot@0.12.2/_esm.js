/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.37.0.
 * Original file: /npm/@uwdata/mosaic-plot@0.12.2/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{synchronizer as t,distinct as e,MosaicClient as n,toDataColumns as s,isParam as i,coordinator as r,throttle as a,clauseInterval as o,clauseIntervals as l,clausePoints as c,clausePoint as h,isSelection as u,Selection as p}from"../mosaic-core@0.12.2/_esm.js";import*as f from"../../@observablehq/plot@0.6.16/_esm.js";import{interpolatorRandomWalk as d,interpolatorBarycentric as g,interpolateNearest as m,scale as y}from"../../@observablehq/plot@0.6.16/_esm.js";import{Query as x,isAggregateExpression as b,column as v,isParamLike as w,isNode as A,collectParams as k,isColumnRef as R,isColumnParam as M,scaleTransform as E,bin1d as S,walk as L,BetweenOpNode as F,m4 as O,isBetween as _,lte as T,lt as z,sum as q,count as D,collectColumns as I,binLinear2d as P,bin2d as $,lineDensity as C,and as N,binLinear1d as j,avg as W,div as B,stddev as G,sqrt as U,geojson as X,float64 as V,add as Y,mul as H,bitAnd as Z,sub as Q,int32 as K,round as J,gt as tt,abs as et,pow as nt,cond as st,neq as it,isNotNull as rt,sql as at,regrIntercept as ot,regrSlope as lt,regrCount as ct,regrSYY as ht,regrSXX as ut,regrAvgX as pt,min as ft,max as dt,ExprNode as gt,floor as mt,dateBin as yt,interval as xt}from"../mosaic-sql@0.12.2/_esm.js";import{color as bt,scaleLinear as vt,InternSet as wt,ascending as At,contours as kt,rgb as Rt,sum as Mt,max as Et,range as St,brush as Lt,brushX as Ft,brushY as Ot,select as _t,min as Tt,pointer as zt,zoom as qt,ZoomTransform as Dt,bisector as It}from"../../d3@7.9.0/_esm.js";const Pt=Symbol("Fixed"),$t=Symbol("Transient"),Ct=Symbol("Transform"),Nt=new Map([["style","style"],["width","width"],["height","height"],["margin","margin"],["marginLeft","marginLeft"],["marginRight","marginRight"],["marginTop","marginTop"],["marginBottom","marginBottom"],["align","align"],["aspectRatio","aspectRatio"],["axis","axis"],["inset","inset"],["grid","grid"],["label","label"],["padding","padding"],["xScale","x.type"],["xDomain","x.domain"],["xRange","x.range"],["xNice","x.nice"],["xInset","x.inset"],["xInsetLeft","x.insetLeft"],["xInsetRight","x.insetRight"],["xClamp","x.clamp"],["xRound","x.round"],["xAlign","x.align"],["xPadding","x.padding"],["xPaddingInner","x.paddingInner"],["xPaddingOuter","x.paddingOuter"],["xAxis","x.axis"],["xTicks","x.ticks"],["xTickSize","x.tickSize"],["xTickSpacing","x.tickSpacing"],["xTickPadding","x.tickPadding"],["xTickFormat","x.tickFormat"],["xTickRotate","x.tickRotate"],["xGrid","x.grid"],["xLine","x.line"],["xLabel","x.label"],["xLabelAnchor","x.labelAnchor"],["xLabelArrow","x.labelArrow"],["xLabelOffset","x.labelOffset"],["xFontVariant","x.fontVariant"],["xAriaLabel","x.ariaLabel"],["xAriaDescription","x.ariaDescription"],["xPercent","x.percent"],["xReverse","x.reverse"],["xZero","x.zero"],["xBase","x.base"],["xExponent","x.exponent"],["xConstant","x.constant"],["yScale","y.type"],["yDomain","y.domain"],["yRange","y.range"],["yNice","y.nice"],["yInset","y.inset"],["yInsetTop","y.insetTop"],["yInsetBottom","y.insetBottom"],["yClamp","y.clamp"],["yRound","y.round"],["yAlign","y.align"],["yPadding","y.padding"],["yPaddingInner","y.paddingInner"],["yPaddingOuter","y.paddingOuter"],["yAxis","y.axis"],["yTicks","y.ticks"],["yTickSize","y.tickSize"],["yTickSpacing","y.tickSpacing"],["yTickPadding","y.tickPadding"],["yTickFormat","y.tickFormat"],["yTickRotate","y.tickRotate"],["yGrid","y.grid"],["yLine","y.line"],["yLabel","y.label"],["yLabelAnchor","y.labelAnchor"],["yLabelArrow","y.labelArrow"],["yLabelOffset","y.labelOffset"],["yFontVariant","y.fontVariant"],["yAriaLabel","y.ariaLabel"],["yAriaDescription","y.ariaDescription"],["yPercent","y.percent"],["yReverse","y.reverse"],["yZero","y.zero"],["yBase","y.base"],["yExponent","y.exponent"],["yConstant","y.constant"],["facetMargin","facet.margin"],["facetMarginTop","facet.marginTop"],["facetMarginBottom","facet.marginBottom"],["facetMarginLeft","facet.marginLeft"],["facetMarginRight","facet.marginRight"],["facetGrid","facet.grid"],["facetLabel","facet.label"],["fxDomain","fx.domain"],["fxRange","fx.range"],["fxInset","fx.inset"],["fxInsetLeft","fx.insetLeft"],["fxInsetRight","fx.insetRight"],["fxRound","fx.round"],["fxAlign","fx.align"],["fxPadding","fx.padding"],["fxPaddingInner","fx.paddingInner"],["fxPaddingOuter","fx.paddingOuter"],["fxAxis","fx.axis"],["fxTicks","fx.ticks"],["fxTickSize","fx.tickSize"],["fxTickSpacing","fx.tickSpacing"],["fxTickPadding","fx.tickPadding"],["fxTickFormat","fx.tickFormat"],["fxTickRotate","fx.tickRotate"],["fxGrid","fx.grid"],["fxLine","fx.line"],["fxLabel","fx.label"],["fxLabelAnchor","fx.labelAnchor"],["fxLabelOffset","fx.labelOffset"],["fxFontVariant","fx.fontVariant"],["fxAriaLabel","fx.ariaLabel"],["fxAriaDescription","fx.ariaDescription"],["fxReverse","fx.reverse"],["fyDomain","fy.domain"],["fyRange","fy.range"],["fyInset","fy,inset"],["fyInsetTop","fy.insetTop"],["fyInsetBottom","fy.insetBottom"],["fyRound","fy.round"],["fyAlign","fy.align"],["fyPadding","fy.padding"],["fyPaddingInner","fy.paddingInner"],["fyPaddingOuter","fy.paddingOuter"],["fyAxis","fy.axis"],["fyTicks","fy.ticks"],["fyTickSize","fy.tickSize"],["fyTickSpacing","fy.tickSpacing"],["fyTickPadding","fy.tickPadding"],["fyTickFormat","fy.tickFormat"],["fyTickRotate","fy.tickRotate"],["fyGrid","fy.grid"],["fyLine","fy.line"],["fyLabel","fy.label"],["fyLabelAnchor","fy.labelAnchor"],["fyLabelOffset","fy.labelOffset"],["fyFontVariant","fy.fontVariant"],["fyAriaLabel","fy.ariaLabel"],["fyAriaDescription","fy.ariaDescription"],["fyReverse","fy.reverse"],["colorScale","color.type"],["colorDomain","color.domain"],["colorRange","color.range"],["colorClamp","color.clamp"],["colorN","color.n"],["colorNice","color.nice"],["colorScheme","color.scheme"],["colorInterpolate","color.interpolate"],["colorPivot","color.pivot"],["colorSymmetric","color.symmetric"],["colorLabel","color.label"],["colorPercent","color.percent"],["colorReverse","color.reverse"],["colorZero","color.zero"],["colorTickFormat","color.tickFormat"],["colorBase","color.base"],["colorExponent","color.exponent"],["colorConstant","color.constant"],["opacityScale","opacity.type"],["opacityDomain","opacity.domain"],["opacityRange","opacity.range"],["opacityClamp","opacity.clamp"],["opacityNice","opacity.nice"],["opacityLabel","opacity.label"],["opacityPercent","opacity.percent"],["opacityReverse","opacity.reverse"],["opacityZero","opacity.zero"],["opacityTickFormat","opacity.tickFormat"],["opacityBase","opacity.base"],["opacityExponent","opacity.exponent"],["opacityConstant","opacity.constant"],["symbolScale","symbol.type"],["symbolDomain","symbol.domain"],["symbolRange","symbol.range"],["rScale","r.type"],["rDomain","r.domain"],["rRange","r.range"],["rClamp","r.clamp"],["rNice","r.nice"],["rLabel","r.label"],["rPercent","r.percent"],["rZero","r.zero"],["rBase","r.base"],["rExponent","r.exponent"],["rConstant","r.constant"],["lengthScale","length.type"],["lengthDomain","length.domain"],["lengthRange","length.range"],["lengthClamp","length.clamp"],["lengthNice","length.nice"],["lengthPercent","length.percent"],["lengthZero","length.zero"],["lengthBase","length.base"],["lengthExponent","length.exponent"],["lengthConstant","length.constant"],["projectionType","projection.type"],["projectionParallels","projection.parallels"],["projectionPrecision","projection.precision"],["projectionRotate","projection.rotate"],["projectionDomain","projection.domain"],["projectionInset","projection.inset"],["projectionInsetLeft","projection.insetLeft"],["projectionInsetRight","projection.insetRight"],["projectionInsetTop","projection.insetTop"],["projectionInsetBottom","projection.insetBottom"],["projectionClip","projection.clip"]]);function jt(t,e,n){for(let s=0;s<e.length;++s){const i=e[s];s===e.length-1?t[i]=n:t=t[i]||(t[i]={})}}const Wt=new Set(["frame","hexgrid","sphere","graticule"]),Bt=new Map([["first",f.selectFirst],["last",f.selectLast],["maxX",f.selectMaxX],["maxY",f.selectMaxY],["minX",f.selectMinX],["minY",f.selectMinY],["nearest",f.pointer],["nearestX",f.pointerX],["nearestXY",f.pointerY]]);async function Gt(t){const e={marks:[]},n=[],{attributes:s,marks:i}=t;!function(t,e,n){for(const s in t){const i=Nt.get(s);if(null==i)throw new Error(`Unrecognized plot attribute: ${s}`);const r=t[s];"symbol"==typeof r?n.push(s):void 0!==r&&jt(e,i.split("."),r)}}(s,e,n);const r=[];for(const t of i)for(const{type:n,data:s,options:i}of t.plotSpecs()){const{select:a,...o}=i,l=Bt.get(a)?.(o)??o,c=Wt.has(n)?[l]:[s,l];e.marks.push(f[n](...c)),r.push(t.index)}!function(t,e){const{marks:n}=e;Ut("x",t,n),Ut("y",t,n),Ut("fx",t,n),Ut("fy",t,n)}(e,t);const a=f.plot(e);!function(t,e){let n=-1;for(const s of t.children){const t=s.getAttribute("aria-label")||"";"style"===s.nodeName||t.includes("-axis")||t.includes("-grid")||s.setAttribute("data-index",e[++n])}}(a,r),function(t,e,n,s){s.forEach((s=>{const i=n[s];if(i!==Pt)throw new Error(`Unrecognized symbol: ${i}`);{if(!s.endsWith("Domain"))throw new Error(`Unsupported fixed attribute: ${s}`);const i=s.slice(0,-6),r=e.scale(i);r?.domain&&t.setAttribute(s,n[`${i}Reverse`]?r.domain.slice().reverse():r.domain)}}))}(t,a,s,n);for(const e of t.interactors)await e.init(a);return a}function Ut(t,e,n){const s=e[t]||{};if(null===s.axis||void 0!==s.label)return;const i=n.map((e=>e.channelField(t)?.field));if(i.every((t=>null==t)))return;let r;for(let t=0;t<i.length;++t){const e=Xt(i[t]);void 0!==e&&(void 0===r?r=e:r!==e&&(r=void 0))}void 0!==r&&(e[t]={...s,label:r})}function Xt(t){if(t){switch(t.type){case"COLUMN_REF":return t.column;case"CAST":return Xt(t.expr);case"FUNCTION":if("make_date"===t.name)return"date"}return function(t){const e=`${t}`.replaceAll('"',"").replaceAll("(*)","()");return e.endsWith("()")?e.slice(0,-2):e}(t)}}const Vt={width:640,marginLeft:40,marginRight:20,marginTop:20,marginBottom:30};class Yt{constructor(e){this.attributes={...Vt},this.listeners=null,this.interactors=[],this.legends=[],this.marks=[],this.markset=null,this.element=e||document.createElement("div"),this.element.setAttribute("class","plot"),this.element.style.display="flex",this.element.value=this,this.params=new Map,this.synch=t()}margins(){return{left:this.getAttribute("marginLeft"),top:this.getAttribute("marginTop"),bottom:this.getAttribute("marginBottom"),right:this.getAttribute("marginRight")}}innerWidth(){const{left:t,right:e}=this.margins();return this.getAttribute("width")-t-e}innerHeight(t=400){const{top:e,bottom:n}=this.margins();let s=this.getAttribute("height");return null==s&&(s=function(t,e,n){const s=t.getAttribute("aspectRatio");if(null==s)return;const i=t.getAttribute("xDomain"),r=t.getAttribute("yDomain");if(!i||!r)return;const a=Math.abs(i[1]-i[0]);return Math.abs(r[1]-r[0])*t.innerWidth()/(s*a)+e+n}(this,e,n)||t,this.setAttribute("height",s,{silent:!0})),s-e-n}pending(t){this.synch.pending(t)}update(t){return this.synch.ready(t)&&!this.pendingRender&&(this.pendingRender=!0,requestAnimationFrame((()=>this.render()))),this.synch.promise}async render(){this.pendingRender=!1;const t=await Gt(this),e=this.legends.flatMap((({legend:e,include:n})=>{const s=e.init(t);return n?s:[]}));this.element.replaceChildren(t,...e),this.synch.resolve()}getAttribute(t){return this.attributes[t]}setAttribute(t,n,s){return!!e(this.attributes[t],n)&&(void 0===n?delete this.attributes[t]:this.attributes[t]=n,s?.silent||this.listeners?.get(t)?.forEach((e=>e(t,n))),!0)}addAttributeListener(t,e){const n=this.listeners||(this.listeners=new Map);return n.has(t)||n.set(t,new Set),n.get(t).add(e),this}removeAttributeListener(t,e){return this.listeners?.get(t)?.delete(e)}addParams(t,e){const{params:n}=this;for(const s of e)n.has(s)?n.get(s).push(t):(n.set(s,[t]),s.addEventListener("value",(()=>Promise.allSettled(n.get(s).map((t=>t.initialize()))))))}addMark(t){return t.setPlot(this,this.marks.length),this.marks.push(t),this.markset=null,this}get markSet(){return this.markset||(this.markset=new Set(this.marks))}addInteractor(t){return this.interactors.push(t),this}addLegend(t,e=!0){t.setPlot(this),this.legends.push({legend:t,include:e})}}function Ht(t){return"string"==typeof t&&("none"===(t=t.toLowerCase().trim())||"currentcolor"===t||t.startsWith("url(")&&t.endsWith(")")||t.startsWith("var(")&&t.endsWith(")")||null!==bt(t))}const Zt=new Set(["offset","order","reverse","sort","label","anchor","curve","tension","marker","markerStart","markerMid","markerEnd","textAnchor","lineAnchor","lineHeight","textOverflow","monospace","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","frameAnchor","strokeLinejoin","strokeLinecap","strokeMiterlimit","strokeDasharray","strokeDashoffset","mixBlendMode","shapeRendering","imageRendering","preserveAspectRatio","interpolate","crossOrigin","paintOrder","pointerEvents","target","select"]);const Qt=new Set(["asterisk","circle","cross","diamond","diamond2","hexagon","plus","square","square2","star","times","triangle","triangle2","wye"]);const Kt=t=>"stroke"===t||"fill"===t,Jt=(t,e)=>({channel:t,field:e,as:R(e)&&!M(e)?e.column:t}),te=(t,e)=>({channel:t,value:e}),ee=t=>Array.isArray(t);class ne extends n{constructor(t,e,n,r={}){super(e?.options?.filterBy),this.type=t,this.reqs=r,this.source=e;const a=this.channels=[],o=this.detail=new Set,l=this.params=new Set;ee(e)?this.data=s(e):i(e?.table)&&l.add(e.table);const c=(t,e)=>{const n=typeof e;if("channels"===t)for(const t in e)o.add(t),c(t,e[t]);else if("function"===n&&e[Ct]){const n=e(this,t);for(const t in n)c(t,n[t])}else if("string"===n)s=t,Zt.has(s)||Kt(t)&&Ht(e)||(t=>"symbol"===t)(t)&&function(t){return Qt.has(`${t}`.toLowerCase())}(e)?a.push(te(t,e)):a.push(Jt(t,v(e)));else if(w(e)){const n=te(t,e.value);a.push(n),e.addEventListener("value",(t=>(n.value=t,this.update())))}else A(e)?(k(e).forEach((t=>l.add(t))),a.push(Jt(t,e))):"object"===n&&((t,e)=>"sort"!==t&&"tip"!==t&&null!=e&&!Array.isArray(e))(t,e)?a.push(Jt(t,e)):void 0!==e&&a.push(te(t,e));var s};for(const t in n)c(t,n[t])}setPlot(t,e){this.plot=t,this.index=e,t.addParams(this,this.params),this.source?.table&&this.queryPending()}sourceTable(){const t=this.source?.table;return t?i(t)?t.value:t:null}hasOwnData(){return null==this.source||ee(this.source)}hasFieldInfo(){return!!this._fieldInfo}channel(t){return this.channels.find((e=>e.channel===t))}channelField(t,{exact:e=!1}={}){const n=e?this.channel(t):this.channels.find((e=>e.channel.startsWith(t)));return n?.field?n:null}fields(){if(this.hasOwnData())return null;const{channels:t,reqs:e}=this,n=new Map;for(const{channel:s,field:i}of t){if(!i)continue;const t=i.stats?.stats||[],r=i.stats?.column??i,a=n.get(r)??n.set(r,new Set).get(r);t.forEach((t=>a.add(t))),e[s]?.forEach((t=>a.add(t)))}const s=this.sourceTable();return Array.from(n,(([t,e])=>({table:s,column:t,stats:Array.from(e)})))}fieldInfo(t){const e=Object.fromEntries(t.map((t=>[t.column,t])));for(const t of this.channels){const{field:n}=t;n&&Object.assign(t,e[n.stats?.column??n])}return this._fieldInfo=!0,this}query(t=[]){return this.hasOwnData()?null:ie(this.channels,this.sourceTable()).where(t)}queryPending(){return this.plot.pending(this),this}queryResult(t){return this.data=s(t),this}update(){return this.plot.update(this)}plotSpecs(){const{type:t,data:e,detail:n,channels:s}=this;return re(t,n,s,e)}}function se(t,e){const n=e?.[t.as]??t.as;return Object.hasOwn(t,"value")?t.value:Kt(t.channel)?{value:n,scale:"color"}:(s=t.channel,/opacity$/i.test(s)?{value:n,scale:"opacity"}:n);var s}function ie(t,e,n=[]){const s=x.from({source:e}),i=new Set;let r=!1;for(const e of t){const{channel:t,field:a,as:o}=e;if(!n.includes(t))if("orderby"===t)s.orderby(e.value);else if(a){if(b(a))r=!0;else{if(i.has(o))continue;i.add(o)}s.select({[o]:a})}}return r&&s.groupby(Array.from(i)),s}function re(t,e,n,s,i={}){const{numRows:r,values:a,columns:o}=s??{},l={};for(const t of n){(e.has(t.channel)?l:i)[t.channel]=se(t,o)}e.size&&(i.channels=l);return[{type:t,data:a??(s?{length:r}:null),options:i}]}function ae(t,e){const{plot:n}=t;let s=n.getAttribute(`${e}Scale`);if(!s){const{type:n}=t.channelField(e);s="date"===n?"time":"linear"}const i={type:s};switch(s){case"log":i.base=n.getAttribute(`${e}Base`)??10;break;case"pow":i.exponent=n.getAttribute(`${e}Exponent`)??1;break;case"symlog":i.constant=n.getAttribute(`${e}Constant`)??1}return E(i)}function oe(t,e,n,s,i=1,r){const{field:a}=t.channelField(e);r=r??a;const{type:o,apply:l,sqlApply:c}=ae(t,e),h=!!t.plot.getAttribute(`${e}Reverse`),[u,p]=s.map((t=>l(t))),f=c(r),d="time"===o||"utc"===o?f:r;return[S(f,u,p,n-i,h),d]}const le={x:["min","max"]},ce={y:["min","max"]},he={...le,...ce};function ue(t,e,n,s,i){const{plot:r}=t,a=r.getAttribute(s),o=r.getAttribute(i);if(Array.isArray(a)&&!a[$t])return a;{const{column:i,min:l,max:c}=t.channelField(n),h=de(e,i)||(o?vt().domain([l,c]).nice().domain():[l,c]);return a!==Pt&&(h[$t]=!0),r.setAttribute(s,h,{silent:!0}),h}}function pe(t,e){return ue(t,e,"x","xDomain","xNice")}function fe(t,e){return ue(t,e,"y","yDomain","yNice")}function de(t,e){if(!t)return;let n,s;return[t].flat().forEach((t=>L(t,(t=>{if(t instanceof F&&`${t.expr}`===e){const e=(t.extent??[]).map((t=>t?.value??t));(null==n||e[0]<n)&&(n=e[0]),(null==s||e[1]>s)&&(s=e[1])}})))),null!=n&&null!=s&&n!==s?[n,s]:void 0}class ge extends ne{constructor(t,e,n){const s=t.endsWith("X")?"y":t.endsWith("Y")?"x":null;super(t,e,n,s?{[s]:["count","min","max"]}:void 0),this.dim=s}query(t=[]){const{plot:e,dim:n,source:s}=this;let i=s.options?.optimize;const r=super.query(t);if(!n)return r;const a="x"===n?"y":"x",o=this.channelField(a,{exact:!0})?.as,{field:l,as:c,type:h,count:u,min:p,max:f}=this.channelField(n),d="date"===h||"number"===h,g="x"===n?e.innerWidth():e.innerHeight();if(i??=u/g>10,i&&d&&o){const[e,s]=de(t,l)||[p,f],[i]=oe(this,n,g,[e,s],1,c),a=r._select.map((t=>t.alias)).filter((t=>t!==c&&t!==o));return O(r,i,c,o,a)}return r.orderby(l)}}function me(t,e=[]){return new e.constructor(t)}function ye(t){let e=1/0,n=-1/0;return t.forEach((t=>{const s=t.length;for(let i=0;i<s;++i){const s=t[i];s<e&&(e=s),s>n&&(n=s)}})),Number.isFinite(e)&&Number.isFinite(n)?[e,n]:[0,1]}function xe(t,e){return i(t)?(t.addEventListener("value",e),t.value):t}function be(t,e=!1){const n=new Float64Array(5),s=new Float64Array(4);!function(t,e,n){const s=4,i=Float64Array.of(.84,1.8675,.84,-1.8675,-.34015,-.1299,-.34015,.1299),r=Math.exp(-1.783/n),a=Math.exp(-1.723/n),o=.6318/n,l=1.997/n,c=Float64Array.of(-r*Math.cos(o),r*Math.sin(o),-r*Math.cos(-o),r*Math.sin(-o),-a*Math.cos(l),a*Math.sin(l),-a*Math.cos(-l),a*Math.sin(-l)),h=2.5066282746310007*n,u=Float64Array.of(i[0],i[1],0,0,0,0,0,0),p=Float64Array.of(1,0,c[0],c[1],0,0,0,0,0,0);let f,d;for(d=2;d<8;d+=2){for(u[d]=c[d]*u[d-2]-c[d+1]*u[d-1],u[d+1]=c[d]*u[d-1]+c[d+1]*u[d-2],f=d-2;f>0;f-=2)u[f]+=c[d]*u[f-2]-c[d+1]*u[f-1],u[f+1]+=c[d]*u[f-1]+c[d+1]*u[f-2];for(f=0;f<=d;f+=2)u[f]+=i[d]*p[f]-i[d+1]*p[f+1],u[f+1]+=i[d]*p[f+1]+i[d+1]*p[f];for(p[d+2]=c[d]*p[d]-c[d+1]*p[d+1],p[d+3]=c[d]*p[d+1]+c[d+1]*p[d],f=d;f>0;f-=2)p[f]+=c[d]*p[f-2]-c[d+1]*p[f-1],p[f+1]+=c[d]*p[f-1]+c[d+1]*p[f-2]}for(d=0;d<s;++d)f=d<<1,e[d]=u[f]/h,t[d+1]=p[f+2]}(n,s,t);const i=Float64Array.of(0,s[1]-n[1]*s[0],s[2]-n[2]*s[0],s[3]-n[3]*s[0],-n[4]*s[0]),r=1+n[1]+n[2]+n[3]+n[4];return{sigma:t,negative:e,a:n,b_causal:s,b_anticausal:i,sum_causal:(s[0]+s[1]+s[2]+s[3])/r,sum_anticausal:(i[1]+i[2]+i[3]+i[4])/r}}function ve(t,e,n,s=1,i=new Float64Array(n),r=new Float64Array(n),a=new Float64Array(5),o=i,l=we){const c=2*s,h=3*s,u=4*s,p=s*n;let f,d;for(l(i,e,n,s,t.b_causal,3,t.a,4,t.sum_causal,a,t.sigma),d=4,f=u;d<n;++d,f+=s)i[d]=t.b_causal[0]*e[f]+t.b_causal[1]*e[f-s]+t.b_causal[2]*e[f-c]+t.b_causal[3]*e[f-h]-t.a[1]*i[d-1]-t.a[2]*i[d-2]-t.a[3]*i[d-3]-t.a[4]*i[d-4];for(l(r,e,n,-s,t.b_anticausal,4,t.a,4,t.sum_anticausal,a,t.sigma),d=4,f=p-5*s;d<n;++d,f-=s)r[d]=t.b_anticausal[1]*e[f+s]+t.b_anticausal[2]*e[f+c]+t.b_anticausal[3]*e[f+h]+t.b_anticausal[4]*e[f+u]-t.a[1]*r[d-1]-t.a[2]*r[d-2]-t.a[3]*r[d-3]-t.a[4]*r[d-4];if(t.negative)for(d=0,f=0;d<n;++d,f+=s)o[f]=i[d]+r[n-d-1];else for(d=0,f=0;d<n;++d,f+=s)o[f]=Math.max(0,i[d]+r[n-d-1]);return o}function we(t,e,n,s,i,r,a,o,l,c,h,u=.5){const p=Math.abs(s)*n,f=s<0?p+s:0;let d,g,m;for(g=0;g<=o;++g)for(c[g]=g<=r?i[g]:0,m=1;m<=o&&m<=g;++m)c[g]-=a[m]*c[g-m];for(m=0;m<o;++m)for(t[m]=0,g=1;g<=m;++g)d=f+s*g,d>=0&&d<p&&(t[m]+=c[m-g]*e[d]);const y=e[f],x=Math.ceil(10*h);for(g=0;g<x;++g){for(m=0;m<o;++m)t[m]+=c[m]*y;if((l-=Math.abs(c[0]))<=u)break;for(c[o]=g+o<=r?i[g+o]:0,m=1;m<=o;++m)c[o]-=a[m]*c[o-m];for(m=0;m<o;++m)c[m]=c[m+1]}}const Ae="density";class ke extends ne{constructor(t,e,n){const{bandwidth:s=0,interpolate:i="none",pixelSize:r=1,pad:a=1,width:o,height:l,...c}=n,h=function(t){const e={};for(const n in t)"density"===t[n]&&(delete t[n],e[n]=!0);return e}(c);super(t,e,c,he),this.densityMap=h,this.bandwidth=xe(s,(t=>(this.bandwidth=t,this.grids?this.convolve().update():null))),this.interpolate=xe(i,(t=>(this.interpolate=t,this.requestUpdate()))),this.pixelSize=xe(r,(t=>(this.pixelSize=t,this.requestUpdate()))),this.pad=xe(a,(t=>(this.pad=t,this.requestUpdate()))),this.width=xe(o,(t=>(this.width=t,this.requestUpdate()))),this.height=xe(l,(t=>(this.height=t,this.requestUpdate())))}setPlot(t,e){const n=()=>{this.hasFieldInfo()&&this.requestUpdate()};t.addAttributeListener("xDomain",n),t.addAttributeListener("yDomain",n),super.setPlot(t,e)}get filterStable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[$t]&&!e[$t]}query(t=[]){const{interpolate:e,pad:n,channels:s,densityMap:i}=this,[r,a]=this.extentX=pe(this,t),[o,l]=this.extentY=fe(this,t),[c,h]=this.bins=this.binDimensions(),[u,p]=oe(this,"x",c,[r,a],n),[f,d]=oe(this,"y",h,[o,l],n),g=n?[_(p,[+r,+a]),_(d,[+o,+l])]:[T(+r,p),z(p,+a),T(+o,d),z(d,+l)],m=x.from(this.sourceTable()).where(t.concat(g)),y=this.groupby=[],v={};for(const t of s)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:s}=t;b(s)?(v[n]=s,i[n]=!0):"weight"===n?v[Ae]=q(s):"x"!==n&&"y"!==n&&(m.select({[e]:s}),y.push(e))}const w=this.aggr=Object.keys(v);if(v.density&&w.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(w.length||(w.push(Ae),v[Ae]=D()),"linear"===e){if(w.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!v[Ae])throw new Error("Linear binning not applicable to custom aggregates.");const t=I(v[Ae])[0];return P(m,u,f,t,c,y)}return $(m,u,f,v,c,y)}binDimensions(){const{plot:t,pixelSize:e,width:n,height:s}=this;return[n??Math.round(t.innerWidth()/e),s??Math.round(t.innerHeight()/e)]}queryResult(t){const[e,n]=this.bins,i=function(t="none"){if("function"==typeof t)return t;switch(t.toLowerCase()){case"none":case"linear":return;case"nearest":return m;case"barycentric":return g();case"random-walk":return d()}throw new Error(`invalid interpolate: ${t}`)}(this.interpolate),{columns:r}=s(t);return this.grids0=function(t,e,n,s,i,r,a){const o=n.length,l=t*e,c=i.map((t=>s[t])),h={},u=[],p=new Int32Array(o);if(r?.length){const t=r.map((t=>s[t])),e={};for(let n=0;n<o;++n){const s=t.map((t=>t[n]));p[n]=e[s]??=u.push(s)-1}for(let t=0;t<r.length;++t)h[r[t]]=u.map((e=>e[t]))}else u.push([]);if(a){const s=n.map((e=>e%t)),r=n.map((e=>Math.floor(e/t))),l=u.map((()=>[]));for(let t=0;t<o;++t)l[p[t]].push(t);i.forEach(((n,i)=>{const o=c[i];h[n]=u.map(((n,i)=>a(l[i],t,e,s,r,o)))}))}else i.forEach(((t,e)=>{const s=c[e],i=h[t]=u.map((()=>me(l,s)));for(let t=0;t<o;++t)i[p[t]][n[t]]=s[t]}));return{numRows:u.length,columns:h}}(e,n,r.index,r,this.aggr,this.groupby,i),this.convolve()}convolve(){const{aggr:t,bandwidth:e,bins:n,grids0:s,plot:i}=this;if(this.grids=s,e>0){const r=1===t.length?t[0]:t.includes(Ae)?Ae:null;if(!r)return console.warn("No compatible grid found for smoothing."),this;const a=s.columns[r],o=i.innerWidth(),l=i.innerHeight(),[c,h]=n,u=a.some((t=>t.some((t=>t<0)))),p=be(e*(c-1)/o,u),f=be(e*(h-1)/l,u);this.grids={numRows:s.numRows,columns:{...s.columns,[r]:a.map((t=>function(t,e,n,[s,i]){const r=new Float64Array(Math.max(s,i)),a=new Float64Array(Math.max(s,i)),o=new Float64Array(5),l=new Float64Array(n.length);for(let e=0,c=0;e<i;++e,c+=s){const e=l.subarray(c);ve(t,n.subarray(c),s,1,r,a,o,e)}for(let t=0;t<s;++t){const n=l.subarray(t);ve(e,n,i,s,r,a,o,n)}return l}(p,f,t,n)))}}}return this}}class Re extends ke{constructor(t,e){const{thresholds:n=10,...s}=e;super("geo",t,{bandwidth:20,interpolate:"linear",pixelSize:2,...s}),this.thresholds=xe(n,(t=>(this.thresholds=t,this.grids?this.contours().update():null)))}convolve(){return super.convolve().contours()}contours(){const{bins:t,densityMap:e,grids:n,thresholds:s,plot:i}=this,{numRows:r,columns:a}=n;let o,l=s;if(Array.isArray(l))o=l;else{const[,t]=ye(a.density);o=Array.from({length:l-1},((e,n)=>t*(n+1)/l))}(e.fill||e.stroke)&&"log"!==this.plot.getAttribute("colorScale")&&this.plot.setAttribute("colorZero",!0);const[c,h]=t,[u,p]=i.getAttribute("xDomain"),[f,d]=i.getAttribute("yDomain"),g=(p-u)/c,m=(d-f)/h,y=+u,x=+f,b=t=>y+t*g,v=t=>x+t*m,w=kt().size(t),A=this.contourData=Array(r*o.length),{density:k,...R}=a,M=Object.entries(R);for(let t=0,e=0;t<r;++t){const n=k[t],s=M.reduce(((e,[n,s])=>(e[n]=s[t],e)),{});for(let t=0;t<o.length;++t,++e)A[e]=Object.assign(Me(w.contour(n,o[t]),b,v),s)}return this}plotSpecs(){const{type:t,channels:e,densityMap:n,contourData:s}=this,i={};for(const t of e){const{channel:e}=t;"x"!==e&&"y"!==e&&(i[e]=se(t))}for(const t in n)n[t]&&(i[t]=se({channel:t,as:"value"}));return[{type:t,data:s,options:i}]}}function Me(t,e,n){function s(t){t.forEach(i)}function i(t){t[0]=e(t[0]),t[1]=n(t[1])}return t.coordinates.forEach((function(t){t.forEach(s)})),t}function Ee(t){return Array.from({length:t},((t,e)=>e))}function Se(t,e){const n=e.reduce(((t,e,n)=>(t[e]=n,t)),{}),s=Ee(t.length);return s.sort(((e,s)=>n[t[e]]-n[t[s]])),s}function Le(t,e){if("undefined"!=typeof document){const n=document.createElement("canvas");return n.setAttribute("width",t),n.setAttribute("height",e),n}throw new Error("Can not create a canvas instance.")}class Fe extends ke{constructor(t,e){super("image",t,e),this.image=null}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,grids:e}=this,[n,s]=t,{numRows:i,columns:r}=e,{canvas:a,ctx:o,img:l}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const s=Le(e,n),i=s.getContext("2d",{willReadFrequently:!0}),r=i.getImageData(0,0,e,n);t.image={canvas:s,ctx:i,img:r,w:e,h:n}}return t.image}(this,n,s),{alpha:c,alphaProp:h,color:u,colorProp:p}=_e(this),f=r[h]??[],d=r[p]??[],g=i>1&&p&&this.groupby?.includes(p)?Se(d,this.plot.getAttribute("colorDomain")):Ee(i);return this.data={numRows:i,columns:{src:Array.from({length:i},((t,e)=>(u?.(l.data,n,s,d[g[e]]),c?.(l.data,n,s,f[g[e]]),o.putImageData(l,0,0),a.toDataURL())))}},this}plotSpecs(){const{type:t,plot:e,data:{numRows:n,columns:s}}=this;return[{type:t,data:{length:n},options:{src:s.src,width:e.innerWidth(),height:e.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}class Oe extends Fe{constructor(t,e){super(t,{bandwidth:20,interpolate:"linear",pixelSize:2,...e})}}function _e(t){const{aggr:e,densityMap:n,groupby:s,plot:i}=t,r=e.includes(Ae),a=e.includes("fillOpacity"),o=t.channel("fill"),l=t.channel("fillOpacity");if(e.length>2||r&&a)throw new Error("Invalid raster encodings. Try dropping an aggregate?");if(s.includes(l?.as))throw new Error("Raster fillOpacity must be an aggregate or constant.");const c=n.fill||e.includes("fill")?"grid":s.includes(o?.as)?"group":Ht(o?.value)?o.value:r&&i.getAttribute("colorScheme")?"grid":void 0,h=n.fillOpacity||e.includes("fillOpacity")?"grid":"number"==typeof l?.value?l.value:r&&"grid"!==c?"grid":void 0;if("grid"!==c&&"grid"!==h)throw new Error("Raster mark missing density values.");const u=o?.as??("grid"===c?Ae:null),p=l?.as??("grid"===h?Ae:null),f="grid"!==c&&"group"!==c?function(t={}){const{r:e=0,g:n=0,b:s=0,opacity:i=1}="string"==typeof t?Rt(t):t,r=new Uint8ClampedArray([e,n,s,255*i|0]);return(t,e,n)=>{for(let s=0,i=0;s<n;++s)for(let n=0;n<e;++n,i+=4)t[i+0]=r[0],t[i+1]=r[1],t[i+2]=r[2],t[i+3]=r[3]}}(c):function(t,e){const{plot:n,grids:s}=t,i=s.columns[e],r=!i[0]?.map,a=r||Array.isArray(i[0]),o=n.getAttribute("colorDomain"),l=o===Pt,c=o?.[$t],h=!l&&!c&&o||(r?i.slice().sort(At):a?function(t){const e=new wt;return t.forEach((t=>{const n=t.length;for(let s=0;s<n;++s)e.add(t[s])})),Array.from(e).sort(At)}(i):ye(i));(l||c||!o)&&(l||(h[$t]=!0),n.setAttribute("colorDomain",h));const u=y({color:{type:n.getAttribute("colorScale"),domain:h,range:n.getAttribute("colorRange"),clamp:n.getAttribute("colorClamp"),n:n.getAttribute("colorN"),nice:n.getAttribute("colorNice"),reverse:n.getAttribute("colorReverse"),scheme:n.getAttribute("colorScheme"),interpolate:n.getAttribute("colorInterpolate"),pivot:n.getAttribute("colorPivot"),symmetric:n.getAttribute("colorSymmetric"),zero:n.getAttribute("colorZero"),base:n.getAttribute("colorBase"),exponent:n.getAttribute("colorExponent"),constant:n.getAttribute("colorConstant")}});if(a)return function(t){const{domain:e,range:n}=t,s=Object.create(null),i=new Uint8ClampedArray(4*e.length),r=e.length-1,a=n.length;for(let t=0;t<=r;++t){const r=n[t%a],{r:o,g:l,b:c,opacity:h=1}="string"==typeof r?Rt(r):r,u=t<<2;i[u+0]=o,i[u+1]=l,i[u+2]=c,i[u+3]=255*h|0,s[e[t]]=u}return(t,e,n,r)=>{if(r.map)for(let a=0,o=0;a<n;++a)for(let l=0,c=(n-a-1)*e;l<e;++l,o+=4){const e=s[r[l+c]];t[o+0]=i[e+0],t[o+1]=i[e+1],t[o+2]=i[e+2],t[o+3]=i[e+3]}else{const a=s[r];for(let s=0,r=0;s<n;++s)for(let n=0;n<e;++n,r+=4)t[r+0]=i[a+0],t[r+1]=i[a+1],t[r+2]=i[a+2],t[r+3]=i[a+3]}}}(u);return function(t,e,n){const{interpolate:s}=e,i=new Uint8ClampedArray(4*t),r=t-1;for(let t=0;t<=r;++t){const e=s(t/r),{r:n,g:a,b:o,opacity:l=1}="string"==typeof e?Rt(e):e,c=t<<2;i[c+0]=n,i[c+1]=a,i[c+2]=o,i[c+3]=255*l|0}return(t,e,s,a)=>{for(let o=0,l=0;o<s;++o)for(let c=0,h=(s-o-1)*e;c<e;++c,l+=4){const e=r*n(a[c+h])<<2;t[l+0]=i[e+0],t[l+1]=i[e+1],t[l+2]=i[e+2],t[l+3]=i[e+3]}}}(1024,u,y({x:{type:Te(u.type),domain:u.domain,reverse:u.reverse,range:[0,1],clamp:u.clamp,base:u.base,exponent:u.exponent,constant:u.constant}}).apply)}(t,u),d="grid"!==h?function(t=1){const e=255*t|0;return(t,n,s)=>{for(let i=0,r=0;i<s;++i)for(let s=0;s<n;++s,r+=4)t[r+3]=e}}(h):function(t,e){const{plot:n,grids:s}=t,i=n.getAttribute("opacityDomain"),r=i===Pt,a=i?.[$t],o=!r&&!a&&i||ye(s.columns[e]);(r||a||!i)&&(r||(o[$t]=!0),n.setAttribute("opacityDomain",o));const l=y({opacity:{type:n.getAttribute("opacityScale"),domain:o,range:n.getAttribute("opacityRange"),clamp:n.getAttribute("opacityClamp"),nice:n.getAttribute("opacityNice"),reverse:n.getAttribute("opacityReverse"),zero:n.getAttribute("opacityZero"),base:n.getAttribute("opacityBase"),exponent:n.getAttribute("opacityExponent"),constant:n.getAttribute("opacityConstant")}});return function(t){const{apply:e}=t;return(t,n,s,i)=>{for(let r=0,a=0;r<s;++r)for(let o=0,l=(s-r-1)*n;o<n;++o,a+=4)t[a+3]=255*e(i[o+l])|0}}(l)}(t,p);return{alphaProp:p,colorProp:u,alpha:d,color:f}}function Te(t){return t.endsWith("symlog")?"symlog":t.endsWith("log")?"log":t.endsWith("pow")?"pow":t.endsWith("sqrt")?"sqrt":"diverging"===t?"linear":t}class ze extends Fe{constructor(t,e){const{normalize:n=!0,...s}=e;super(t,s),this.normalize=xe(n,(t=>(this.normalize=t,this.requestUpdate())))}query(t=[]){const{channels:e,normalize:n,pad:s}=this,[i,r]=this.bins=this.binDimensions(),[a]=oe(this,"x",i,pe(this,t),s),[o]=oe(this,"y",r,fe(this,t),s),l=x.from(this.sourceTable()).where(function(t,e){if(Array.isArray(e)&&!e.length)return e;const n=t.channelField("x").column,s=t.channelField("y").column,i=t=>{const e=`${t.expr}`;return"BETWEEN"!==t.type||e!==n&&e!==s},r=t=>"AND"===t.op?N(t.clauses.filter((t=>i(t)))):t;return Array.isArray(e)?e.filter((t=>i(t))).map((t=>r(t))):r(e)}(this,t));this.aggr=["density"];const c=this.groupby=[],h=[];for(const t of e)if(Object.hasOwn(t,"field")){const{channel:e,field:n}=t;"z"===e?(l.select({[e]:n}),h.push("z")):"x"!==e&&"y"!==e&&(l.select({[e]:n}),c.push(e))}return C(l,a,o,h,i,r,c,n)}}const qe={fill:1,stroke:1,z:1};class De extends ne{constructor(t,e,n){const{bins:s=1024,bandwidth:i=20,normalize:r=!1,stack:a=!1,...o}=n,l=t.endsWith("X")?"y":"x";super(t,e,o,"x"===l?le:ce),this.dim=l,this.bins=xe(s,(t=>(this.bins=t,this.requestUpdate()))),this.bandwidth=xe(i,(t=>(this.bandwidth=t,this.grids?this.convolve().update():null))),this.normalize=xe(r,(t=>(this.normalize=t,this.convolve().update()))),this.stack=xe(a,(t=>(this.stack=t,this.update())))}get filterStable(){const t="x"===this.dim?"xDomain":"yDomain",e=this.plot.getAttribute(t);return e&&!e[$t]}query(t=[]){if(this.hasOwnData())throw new Error("Density1DMark requires a data source");const{bins:e,channels:n,dim:s}=this,i=this.extent=("x"===s?pe:fe)(this,t),[r,a]=oe(this,s,e,i),o=ie(n,this.sourceTable(),[s]).where(t.concat(_(a,i))),l=this.channelField("weight")?"weight":null,c=this.groupby=n.flatMap((t=>qe[t.channel]&&t.field?t.as:[]));return j(o,r,l,c)}queryResult(t){const e=s(t).columns;return this.grids=function(t,e,n,s,i){const r=e.length,a={},o=[];if(i?.length){const l=new Int32Array(r),c=i.map((t=>s[t])),h={};for(let t=0;t<r;++t){const e=c.map((e=>e[t]));l[t]=h[e]??=o.push(e)-1}for(let t=0;t<i.length;++t)a[i[t]]=o.map((e=>e[t]));const u=a._grid=o.map((()=>me(t,n)));for(let t=0;t<r;++t)u[l[t]][e[t]]=n[t]}else{o.push([]);const[s]=a._grid=[me(t,n)];for(let t=0;t<r;++t)s[e[t]]=n[t]}return{numRows:o.length,columns:a}}(this.bins,e.index,e.density,e,this.groupby),this.convolve()}convolve(){const{bins:t,bandwidth:e,normalize:n,dim:s,grids:i,groupby:r,plot:a,extent:[o,l]}=this,c=i.columns,h=i.numRows,u=this.channelField(s).as,p="x"===s?"y":"x",f="x"===s?a.innerWidth():a.innerHeight(),d=c._grid.some((t=>t.some((t=>t<0)))),g=be(e*(t-1)/f,d),m=+o,y=(l-m)/(t-1),x=t*h,b=new Float64Array(x),v=new Float64Array(x),w=r.reduce(((t,e)=>(t[e]=Array(x),t)),{});for(let e=0,s=0;s<h;++s){r.forEach((n=>w[n].fill(c[n][s],e,e+t)));const i=c._grid[s],a=ve(g,i,t),o=1/Ie(i,a,y,n);for(let n=0;n<t;++n,++e)b[e]=m+n*y,v[e]=a[n]*o}return this.data={numRows:x,columns:{[u]:b,[p]:v,...w}},this}plotSpecs(){const{type:t,data:{numRows:e,columns:n},channels:s,dim:i,stack:r}=this,a=t.startsWith("area")&&!r?"2":"",o="x"===i?{[`y${a}`]:n.y}:{[`x${a}`]:n.x};for(const t of s)o[t.channel]=se(t,n);return[{type:t,data:{length:e},options:o}]}}function Ie(t,e,n,s){return(!0===s||"sum"===s?Mt(t):"max"===s?Et(e):n)||1}class Pe extends ke{constructor(t,e){const{type:n="dot",...s}=e;super(n,t,{bandwidth:20,interpolate:"linear",pad:0,pixelSize:2,...s})}convolve(){super.convolve();const{bins:t,pad:e,extentX:n,extentY:s}=this,[i,r]=t,a=ae(this,"x"),o=ae(this,"y"),[l,c]=n.map((t=>a.apply(t))),[h,u]=s.map((t=>o.apply(t))),p=(c-l)/(i-e),f=(u-h)/(r-e),d=e?0:.5;return this.data=function(t,e,n,s,i,r,a,o,l){const c=1/(i*r),[h,u]=e,p=h*u,f=p*t.numRows,d=new Float64Array(f),g=new Float64Array(f),m=new Float64Array(f),y={x:d,y:g,density:m},{density:x,...b}=t.columns;for(const t in b)y[t]=new b[t].constructor(f);let v=0;for(let e=0;e<t.numRows;++e){for(const t in b)y[t].fill(b[t][e],v,v+p);const t=x[e];for(let e=0,p=0;p<u;++p)for(let u=0;u<h;++u,++v,++e)d[v]=a(n+(u+l)*i),g[v]=o(s+(p+l)*r),m[v]=t[e]*c}return{numRows:f,columns:y}}(this.grids,t,l,h,p,f,a.invert,o.invert,d),this}plotSpecs(){const{type:t,channels:e,densityMap:n,data:{numRows:s,columns:i}}=this,r={};for(const t of e){const{channel:e}=t;r[e]="x"===e||"y"===e?i[e]:se(t,i)}for(const t in n)n[t]&&(r[t]=i.density);return[{type:t,data:{length:s},options:r}]}}function $e(t,e,n){var s=0===t||1===t?0:Math.exp(Ne(e+n)-Ne(e)-Ne(n)+e*Math.log(t)+n*Math.log(1-t));return t<0||t>1?0:t<(e+1)/(e+n+2)?s*Ce(t,e,n)/e:1-s*Ce(1-t,n,e)/n}function Ce(t,e,n){var s,i,r,a,o=1e-30,l=1,c=e+n,h=e+1,u=e-1,p=1,f=1-c*t/h;for(Math.abs(f)<o&&(f=o),a=f=1/f;l<=100&&(f=1+(i=l*(n-l)*t/((u+(s=2*l))*(e+s)))*f,Math.abs(f)<o&&(f=o),p=1+i/p,Math.abs(p)<o&&(p=o),a*=(f=1/f)*p,f=1+(i=-(e+l)*(c+l)*t/((e+s)*(h+s)))*f,Math.abs(f)<o&&(f=o),p=1+i/p,Math.abs(p)<o&&(p=o),a*=r=(f=1/f)*p,!(Math.abs(r-1)<3e-7));l++);return a}function Ne(t){var e,n,s,i=0,r=[76.18009172947146,-86.5053203294167,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18],a=1.000000000190015;for(s=(n=e=t)+5.5,s-=(e+.5)*Math.log(s);i<6;i++)a+=r[i]/++n;return Math.log(2.506628274631*a/e)-s}function je(t,e){var n=function(t,e,n){var s,i,r,a,o,l,c,h,u,p,f=e-1,d=n-1,g=0;if(t<=0)return 0;if(t>=1)return 1;for(e>=1&&n>=1?(r=t<.5?t:1-t,l=(2.30753+.27061*(a=Math.sqrt(-2*Math.log(r))))/(1+a*(.99229+.04481*a))-a,t<.5&&(l=-l),c=(l*l-3)/6,h=2/(1/(2*e-1)+1/(2*n-1)),u=l*Math.sqrt(c+h)/h-(1/(2*n-1)-1/(2*e-1))*(c+5/6-2/(3*h)),l=e/(e+n*Math.exp(2*u))):(s=Math.log(e/(e+n)),i=Math.log(n/(e+n)),l=t<(a=Math.exp(e*s)/e)/(u=a+(o=Math.exp(n*i)/n))?Math.pow(e*u*t,1/e):1-Math.pow(n*u*(1-t),1/n)),p=-Ne(e)-Ne(n)+Ne(e+n);g<10;g++){if(0===l||1===l)return l;if((l-=a=(o=($e(l,e,n)-t)/(a=Math.exp(f*Math.log(l)+d*Math.log(1-l)+p)))/(1-.5*Math.min(1,o*(f/l-d/(1-l)))))<=0&&(l=.5*(l+a)),l>=1&&(l=.5*(l+a+1)),Math.abs(a)<1e-8*l&&g>0)break}return l}(2*Math.min(t,1-t),.5*e,.5);return n=Math.sqrt(e*(1-n)/n),t>.5?n:-n}class We extends ne{constructor(t,e,n){const s=t.endsWith("X")?"y":"x",{ci:i=.95,...r}=n;super(t,e,r),this.dim=s,this.field=this.channelField(s).field,this.channels=this.channels.filter((t=>t.channel!==s)),this.ci=xe(i,(t=>(this.ci=t,this.update())))}query(t=[]){const{channels:e,field:n}=this;return ie(e.concat([{field:W(n),as:"__avg__"},{field:B(G(n),U(D(n))),as:"__se__"}]),this.sourceTable()).where(t)}queryResult(t){return this.data=s(t),this}plotSpecs(){const{type:t,dim:e,detail:n,data:s,ci:i,channels:r}=this,a=Math.SQRT2*function(t){let e,n=-Math.log((1-t)*(1+t));return n<6.25?(n-=3.125,e=-364441206401782e-35,e=e*n-16850591381820166e-35,e=128584807152564e-32+e*n,e=11157877678025181e-33+e*n,e=e*n-1333171662854621e-31,e=20972767875968562e-33+e*n,e=6637638134358324e-30+e*n,e=e*n-4054566272975207e-29,e=e*n-8151934197605472e-29,e=26335093153082323e-28+e*n,e=e*n-12975133253453532e-27,e=e*n-5415412054294628e-26,e=1.0512122733215323e-9+e*n,e=e*n-4.112633980346984e-9,e=e*n-2.9070369957882005e-8,e=4.2347877827932404e-7+e*n,e=e*n-13654692000834679e-22,e=e*n-13882523362786469e-21,e=.00018673420803405714+e*n,e=e*n-.000740702534166267,e=e*n-.006033670871430149,e=.24015818242558962+e*n,e=1.6536545626831027+e*n):n<16?(n=Math.sqrt(n)-3.25,e=2.2137376921775787e-9,e=9.075656193888539e-8+e*n,e=e*n-2.7517406297064545e-7,e=1.8239629214389228e-8+e*n,e=15027403968909828e-22+e*n,e=e*n-4013867526981546e-21,e=29234449089955446e-22+e*n,e=12475304481671779e-21+e*n,e=e*n-47318229009055734e-21,e=6828485145957318e-20+e*n,e=24031110387097894e-21+e*n,e=e*n-.0003550375203628475,e=.0009532893797373805+e*n,e=e*n-.0016882755560235047,e=.002491442096107851+e*n,e=e*n-.003751208507569241,e=.005370914553590064+e*n,e=1.0052589676941592+e*n,e=3.0838856104922208+e*n):Number.isFinite(n)?(n=Math.sqrt(n)-5,e=-27109920616438573e-27,e=e*n-2.555641816996525e-10,e=1.5076572693500548e-9+e*n,e=e*n-3.789465440126737e-9,e=7.61570120807834e-9+e*n,e=e*n-1.496002662714924e-8,e=2.914795345090108e-8+e*n,e=e*n-6.771199775845234e-8,e=2.2900482228026655e-7+e*n,e=e*n-9.9298272942317e-7,e=4526062597223154e-21+e*n,e=e*n-1968177810553167e-20,e=7599527703001776e-20+e*n,e=e*n-.00021503011930044477,e=e*n-.00013871931833623122,e=1.0103004648645344+e*n,e=4.849906401408584+e*n):e=1/0,e*t}(i),{columns:{__avg__:o,__se__:l}}=s;return re(t,n,r,s,{[`${e}1`]:o.map(((t,e)=>t-a*l[e])),[`${e}2`]:o.map(((t,e)=>t+a*l[e]))})}}class Be extends ne{constructor(t,e={},n){ee(t)||e?.geometry||(e.geometry=X("geom")),super("geo",t,e,n)}queryResult(t){super.queryResult(t);const e=this.channelField("geometry")?.as;if(e){const{columns:t}=this.data;"string"==typeof t[e][0]&&(t[e]=t[e].map((t=>JSON.parse(t))))}return this}}class Ge extends ne{constructor(t,e){const{type:n="hexagon",binWidth:s=20,...i}=e;super(n,t,{r:s/2,clip:!0,...i},he),this.binWidth=xe(s,(t=>(this.binWidth=t,this.requestUpdate())))}get filterStable(){const t=this.plot.getAttribute("xDomain"),e=this.plot.getAttribute("yDomain");return t&&e&&!t[$t]&&!e[$t]}query(t=[]){if(this.hasOwnData())return null;const{plot:e,binWidth:n,channels:s}=this;let i,r;const a=new Set,o={};for(const t of s)if("orderby"===t.channel);else if("x"===t.channel)i=t;else if("y"===t.channel)r=t;else if(Object.hasOwn(t,"field")){const{as:e,field:n}=t;o[e]=n,b(n)||a.add(e)}const[l,c]=pe(this,t),[h,u]=fe(this,t),p=.5-e.getAttribute("marginLeft"),f=0-e.getAttribute("marginTop"),d=V(n),g=V(n*(1.5/Math.sqrt(3))),m=V(e.innerWidth()/(c-l)),y=V(e.innerHeight()/(u-h)),v="_x",w="_y",A="_px",k="_py",R="_pi",M="_pj",E="_tt";return x.select({[i.as]:Y(V(l),B(Y(H(Y(v,H(.5,Z(w,1))),d),p),m)),[r.as]:Q(V(u),B(Y(H(w,g),f),y)),...o}).groupby(v,w,...a).from(x.select({[k]:B(Q(H(y,Q(u,r.field)),f),g),[M]:K(J(k)),[A]:Q(B(Q(H(m,Q(i.field,l)),p),d),H(.5,Z(M,1))),[R]:K(J(A)),[E]:N(tt(H(et(Q(k,M)),3),1),tt(Y(nt(Q(A,R),2),nt(Q(k,M),2)),Y(nt(Q(Q(A,R),H(.5,st(z(A,R),-1,1))),2),nt(Q(Q(k,M),st(z(k,M),-1,1)),2)))),[v]:st(E,K(Y(Y(R,st(z(A,R),-.5,.5)),st(it(Z(M,1),0),.5,-.5))),R),[w]:st(E,K(Y(M,st(z(k,M),-1,1))),M)},"*").from(this.sourceTable()).where(rt(i.field),rt(r.field),t))}}class Ue extends ke{constructor(t,e){const{origin:n=[0,0],dim:s="xy",...i}=e;super("image",t,i),this.image=null,this.origin=n,this.tileX=s.toLowerCase().includes("x"),this.tileY=s.toLowerCase().includes("y")}setPlot(t,e){t.addAttributeListener("schemeColor",(()=>{this.hasFieldInfo()&&this.rasterize()})),super.setPlot(t,e)}requestQuery(){return this.requestTiles()}query(t=[]){return this._filter=t,null}tileQuery(t){const{interpolate:e,pad:n,channels:s,densityMap:i}=this,[[r,a],[o,l]]=t,[c,h]=this.bins,[u,p]=oe(this,"x",c,[r,a],n),[f,d]=oe(this,"y",h,[o,l],n),g=n?[_(p,[+r,+a]),_(d,[+o,+l])]:[T(+r,p),z(p,+a),T(+o,d),z(d,+l)],m=x.from(this.sourceTable()).where(g),y=this.groupby=[],b={};for(const t of s)if(Object.hasOwn(t,"field")){const{as:e,channel:n,field:s}=t;s.aggregate?(b[n]=s,i[n]=!0):"weight"===n?b.density=q(s):"x"!==n&&"y"!==n&&(m.select({[e]:s}),y.push(e))}const v=this.aggr=Object.keys(b);if(b.density&&v.length>1)throw new Error("Weight option can not be used with custom aggregates.");if(v.length||(v.push("density"),b.density=D()),"linear"===e){if(v.length>1)throw new Error("Linear binning not applicable to multiple aggregates.");if(!b.density)throw new Error("Linear binning not applicable to custom aggregates.");return function(t,e,n,s,i,r){const a=s.column?`* ${s.column}`:"",o=(s,i)=>t.clone().select({xp:e,yp:n,i:s,w:i}),l=o(at`FLOOR(xp)::INTEGER + FLOOR(yp)::INTEGER * ${i}`,at`(FLOOR(xp)::INTEGER + 1 - xp) * (FLOOR(yp)::INTEGER + 1 - yp)${a}`),c=o(at`FLOOR(xp)::INTEGER + (FLOOR(yp)::INTEGER + 1) * ${i}`,at`(FLOOR(xp)::INTEGER + 1 - xp) * (yp - FLOOR(yp)::INTEGER)${a}`),h=o(at`FLOOR(xp)::INTEGER + 1 + FLOOR(yp)::INTEGER * ${i}`,at`(xp - FLOOR(xp)::INTEGER) * (FLOOR(yp)::INTEGER + 1 - yp)${a}`),u=o(at`FLOOR(xp)::INTEGER + 1 + (FLOOR(yp)::INTEGER + 1) * ${i}`,at`(xp - FLOOR(xp)::INTEGER) * (yp - FLOOR(yp)::INTEGER)${a}`);return x.from(x.unionAll(l,c,h,u)).select({index:"i",density:q("w")},r).groupby("index",r).having(it("density",0))}(m,u,f,b.density,c,y)}return function(t,e,n,s,i,r){return t.select({index:at`FLOOR(${e})::INTEGER + FLOOR(${n})::INTEGER * ${i}`,...s}).groupby("index",r)}(m,u,f,b,c,y)}async requestTiles(){const t=r();this.prefetch&&t.cancel(this.prefetch);const{pad:e,tileX:n,tileY:s,origin:[i,a]}=this,[o,l]=this.bins=this.binDimensions(),[c,h]=pe(this,this._filter),[u,p]=fe(this,this._filter),f=h-c,d=p-u,g=Math.floor((c-i)*(o-e)/f),m=Math.floor((u-a)*(l-e)/d),y=(t,e)=>[[i+t*f,i+(t+1)*f],[a+e*d,a+(e+1)*d]],x=Math.floor((c-i)/f),b=n?Xe((h-i)/f):x,v=Math.floor((u-a)/d),w=s?Xe((p-a)/d):v,A=[];for(let t=x;t<=b;++t)for(let e=v;e<=w;++e)A.push([t,e]);const k=A.map((([e,n])=>t.query(this.tileQuery(y(e,n))))),R=[];if(n)for(let t=v;t<=w;++t)R.push([b+1,t]),R.push([x-1,t]);if(s){const t=n?b+1:b;for(let e=n?x-1:x;e<=t;++e)R.push([e,w+1]),R.push([e,v-1])}this.prefetch=R.map((([e,n])=>t.prefetch(this.tileQuery(y(e,n)))));const M=function(t,e,n,s,i,r){const a=new Float64Array(t*e);return r.forEach(((r,o)=>{const[l,c]=i[o];!function(t,e,n,s,i,r){const a=s.numRows;if(0===a)return;const o=s.getChild("index").toArray(),l=s.getChild("density").toArray();for(let s=0;s<a;++s){const a=o[s],c=i+a%t,h=r+Math.floor(a/t);0<=c&&c<t&&0<=h&&h<e&&(n[c+h*t]=l[s])}}(t,e,a,r,l*t-n,c*e-s)})),a}(o,l,g,m,A,await Promise.all(k));this.grids0={numRows:M.length,columns:{density:[M]}},this.convolve().update()}convolve(){return super.convolve().rasterize()}rasterize(){const{bins:t,grids:e}=this,[n,s]=t,{numRows:i,columns:r}=e,{canvas:a,ctx:o,img:l}=function(t,e,n){if(!t.image||t.image.w!==e||t.image.h!==n){const s=Le(e,n),i=s.getContext("2d",{willReadFrequently:!0}),r=i.getImageData(0,0,e,n);t.image={canvas:s,ctx:i,img:r,w:e,h:n}}return t.image}(this,n,s),{alpha:c,alphaProp:h,color:u,colorProp:p}=_e(this),f=r[h]??[],d=r[p]??[],g=i>1&&p&&this.groupby?.includes(p)?Se(d,this.plot.getAttribute("colorDomain")):Ee(i);return this.data={numRows:i,columns:{src:Array.from({length:i},((t,e)=>(u?.(l.data,n,s,d[g[e]]),c?.(l.data,n,s,f[g[e]]),o.putImageData(l,0,0),a.toDataURL())))}},this}plotSpecs(){const{type:t,plot:e,data:{numRows:n,columns:s}}=this;return[{type:t,data:{length:n},options:{src:s.src,width:e.innerWidth(),height:e.innerHeight(),preserveAspectRatio:"none",imageRendering:this.channel("imageRendering")?.value,frameAnchor:"middle"}}]}}function Xe(t){const e=Math.floor(t);return e===t?e-1:e}class Ve extends ne{constructor(t,e){const{ci:n=.95,precision:s=4,...i}=e;super("line",t,i);const r=()=>this.modelFit?this.confidenceBand().update():null;this.ci=xe(n,(t=>(this.ci=t,r()))),this.precision=xe(s,(t=>(this.precision=t,r())))}query(t=[]){const e=this.channelField("x").as,n=this.channelField("y").as,s=Array.from(new Set(["stroke","z","fx","fy"].flatMap((t=>this.channelField(t)?.as||[]))));return x.from(super.query(t)).select({intercept:ot(n,e),slope:lt(n,e),n:ct(n,e),ssy:ht(n,e),ssx:ut(n,e),xm:pt(n,e),x0:V(ft(e).where(rt(n))),x1:V(dt(e).where(rt(n)))}).select(s).groupby(s)}queryResult(t){return this.modelFit=s(t),this.lineData=function(t){const{x0:e=[],x1:n=[],xm:s,intercept:i,slope:r,n:a,ssx:o,ssy:l,...c}=t.columns,h=(t,e)=>i[e]+t*r[e],u=Ye(e,n),p=Ye(e.map(h),n.map(h));for(const t in c)c[t]=Ye(c[t],c[t]);return{numRows:u.length,columns:{x:u,y:p,...c}}}(this.modelFit),this.confidenceBand()}confidenceBand(){const{ci:t,modelFit:e,precision:n,plot:s}=this,i=s.innerWidth();return this.areaData=t?function(t,e,n,s){const i=t.numRows,{x0:r,x1:a,xm:o,intercept:l,slope:c,n:h,ssx:u,ssy:p,...f}=t.columns,d=Object.keys(f),g={x:[],y1:[],y2:[]};d.forEach((t=>g[t]=[]));for(let t=0;t<i;++t){const i=n*(a[t]-r[t])/s,m=je((1-e)/2,h[t]-2)*Math.sqrt(p[t]/(h[t]-2));St(r[t],a[t]-i/2,i).concat(a[t]).forEach((e=>{const n=l[t]+e*c[t],s=m*Math.sqrt(1/h[t]+(e-o[t])**2/u[t]);g.x.push(e),g.y1.push(n-s),g.y2.push(n+s),d.forEach((e=>g[e].push(f[e][t])))}))}return{numRows:g.x.length,columns:g}}(e,t,n,i):null,this}plotSpecs(){const{lineData:t,areaData:e,channels:n,ci:s}=this,i=t.columns,r=s?e.columns:{},a={x:i.x,y:i.y},o={x:r.x,y1:r.y1,y2:r.y2,fillOpacity:.1};for(const t of n)switch(t.channel){case"x":case"y":case"fill":break;case"tip":o.tip=se(t,r);break;case"stroke":a.stroke=se(t,i),o.fill=se(t,r);break;case"strokeOpacity":a.strokeOpacity=se(t,i);break;case"fillOpacity":o.fillOpacity=se(t,r);break;default:a[t.channel]=se(t,i),o[t.channel]=se(t,r)}return[...s?[{type:"areaY",data:{length:e.numRows},options:o}]:[],{type:"line",data:{length:t.numRows},options:a}]}}function Ye(t,e){if(t.concat)return t.concat(e);const n=new t.constructor(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function He(t){"a"===t.tagName&&(t=t.children[0]);const e=t.__data__;return Array.isArray(e)?e[0]:e}function Ze(t){const e=t.toLowerCase(),n=t.length;let s="";for(let i=0;i<n;++i)s+=(t[i]!==e[i]?"-":"")+e[i];return s}function Qe(t){const e={};for(const n in t)e[Ze(n)]=t[n];return e}class Ke{constructor(t,{selection:e,channels:n={}}){this.mark=function(t){const{channels:e}=t,n=new Set;let s=!1,i=!1;for(const t of e){const{channel:e,field:r,as:a}=t;if("orderby"===e)s=!0;else if(r)if(b(r))i=!0;else{if(n.has(a))continue;n.add(a)}}return!s&&i&&n.size&&t.channels.push({channel:"orderby",value:Array.from(n)}),t}(t),this.selection=e;const s=Object.entries(Qe(n));this.channels=s.length?s:[["opacity",.2]],this.selection.addEventListener("value",a((()=>this.update())))}init(t){this.svg=t;const e=this.values=[],n=`g[data-index="${this.mark.index}"]`,s=`${n} > *:not(g), ${n} > g > *`,i=this.nodes=t.querySelectorAll(s),{channels:r}=this;for(let t=0;t<i.length;++t){const n=i[t];e.push(r.map((t=>n.getAttribute(t[0]))))}return this.update()}async update(){const{svg:t,nodes:e,channels:n,values:s,mark:i,selection:r}=this;if(!t)return;const a=await async function(t,e){const n=e?.predicate(t);if(!n||0===n.length)return()=>!0;const s=t.filterBy?.predicate(t,!0),i={__:N(n)},r=t.query(s);(r.queries||[r]).forEach((t=>{t._groupby.length?t.select(i):t.setSelect(i)}));const a=await t.coordinator.query(r),o=a.getChild?.("__");return a.numRows||a.length?o?t=>o.at(t):t=>a[t].__:()=>!1}(i,r);for(let t=0;t<e.length;++t){const i=e[t],r=s[t],o=a(He(i));for(let t=0;t<n.length;++t){const[e,s]=n[t];i.setAttribute(e,o?r[t]:s)}}}}function Je(){const t=this,e=t.getScreenCTM;let n;t.getScreenCTM=()=>t.isConnected?n=e.call(t):n}function tn(t){const e=t.on;let n=!0;function s(t){n=!1,t(),n=!0}return t.reset=(...e)=>{s((()=>t.clear(...e)))},t.moveSilent=(...e)=>{s((()=>t.move(...e)))},t.on=(...t)=>{if(t.length>1&&t[1]){const e=t[1];t[1]=(...t)=>n&&e(...t)}return e(...t)},t}function en(){return tn(Lt())}function nn(t,e,n,s,i){let r=_t(e??t).append("g").attr("class",i);const a=t.scale("fx"),o=t.scale("fy");if(a||o){const t=a?.domain.map((t=>a.apply(t)-n)),e=o?.domain.map((t=>o.apply(t)-s));if(t&&e)for(let n=0;n<t.length;++n)for(let s=0;s<e.length;++s)r.append("g").attr("transform",`translate(${t[n]}, ${e[s]})`);else if(t)for(let e=0;e<t.length;++e)r.append("g").attr("transform",`translate(${t[e]}, 0})`);else if(e)for(let t=0;t<e.length;++t)r.append("g").attr("transform",`translate(0, ${e[t]})`);r=r.selectAll("g")}return r.each(Je)}function sn(t,e){return t===e||t&&e&&Math.abs(t[0]-e[0])<1e-12&&Math.abs(t[1]-e[1])<1e-12||!1}function rn(t){if(A(t)){if("COLUMN_REF"===t.type)return t.column;if("AGGREGATE"===t.type)return t.args[0]??t}return t}function an(t,e){return rn(t.channelField(e)?.field)}function on(t,e,n=1){return e.invert(n*Math.floor(t/n))}class ln{constructor(t,{channel:e,selection:n,field:s,pixelSize:i=1,peers:r=!0,brush:a}){this.mark=t,this.channel=e,this.pixelSize=i||1,this.selection=n,this.peers=r,this.field=s||an(t,e),this.style=a&&Qe(a),this.brush=tn("y"===e?Ot():Ft()),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[0,1]))}publish(t){let e;t&&(e=t.map((t=>on(t,this.scale,this.pixelSize))).sort(((t,e)=>t-e))),sn(e,this.value)||(this.value=e,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(e)))}clause(t){const{mark:e,pixelSize:n,field:s,scale:i}=this;return o(s,t,{source:this,clients:this.peers?e.plot.markSet:(new Set).add(e),scale:i,pixelSize:n})}init(t,e){const{brush:n,channel:s,style:i}=this;this.scale=t.scale(s);const r=this.value?.map(this.scale.apply).sort(At),a=t.scale("x").range,o=t.scale("y").range;if(n.extent([[Tt(a),Tt(o)],[Et(a),Et(o)]]),this.g=nn(t,e,Tt(a),Tt(o),`interval-${s}`).call(n).call(n.moveSilent,r),i){const t=this.g.selectAll("rect.selection");for(const e in i)t.attr(e,i[e])}t.addEventListener("pointerenter",(t=>{t.buttons||this.activate()}))}}class cn{constructor(t,{selection:e,xfield:n,yfield:s,pixelSize:i=1,peers:r=!0,brush:a}){this.mark=t,this.pixelSize=i||1,this.selection=e,this.peers=r,this.xfield=n||an(t,"x"),this.yfield=s||an(t,"y"),this.style=a&&Qe(a),this.brush=en(),this.brush.on("brush end",(({selection:t})=>this.publish(t)))}reset(){this.value=void 0,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause(this.value||[[0,1],[0,1]]))}publish(t){const{value:e,pixelSize:n,xscale:s,yscale:i}=this;let r,a;if(t){const[e,o]=t;r=[e[0],o[0]].map((t=>on(t,s,n))).sort(At),a=[e[1],o[1]].map((t=>on(t,i,n))).sort(At)}sn(r,e?.[0])&&sn(a,e?.[1])||(this.value=t?[r,a]:void 0,this.g.call(this.brush.moveSilent,t),this.selection.update(this.clause(this.value)))}clause(t){const{mark:e,pixelSize:n,xfield:s,yfield:i,xscale:r,yscale:a}=this;return l([s,i],t,{source:this,clients:this.peers?e.plot.markSet:(new Set).add(e),scales:[r,a],pixelSize:n})}init(t){const{brush:e,style:n,value:s}=this,i=this.xscale=t.scale("x"),r=this.yscale=t.scale("y"),a=i.range,o=r.range;if(e.extent([[Tt(a),Tt(o)],[Et(a),Et(o)]]),this.g=nn(t,null,Tt(a),Tt(o),"interval-xy").call(e),n){const t=this.g.selectAll("rect.selection");for(const e in n)t.attr(e,n[e])}if(s){const[t,n]=s[0].map(i.apply).sort(At),[a,o]=s[1].map(r.apply).sort(At);this.g.call(e.moveSilent,[[t,a],[n,o]])}t.addEventListener("pointerenter",(t=>{t.buttons||this.activate()}))}}class hn{constructor(t,{selection:e,pointer:n,channels:s,fields:i,maxRadius:r=40}){this.mark=t,this.selection=e,this.clients=(new Set).add(t),this.pointer=n,this.channels=s||("x"===n?["x"]:"y"===n?["y"]:["x","y"]),this.fields=i||this.channels.map((e=>an(t,[e]))),this.maxRadius=r,this.valueIndex=-1}clause(t){const{clients:e,fields:n}=this,s={source:this,clients:e};return n.length>1?c(n,t?[t]:t,s):h(n[0],t?.[0],s)}init(t){const e=this,{mark:n,channels:s,selection:i,maxRadius:r}=this,{data:{columns:a}}=n,o=s.map((t=>n.channelField(t).as)),l=!u(i),[c,h]=function(t,e){const{data:{columns:n}}=e,s=t=>n[e.channelField(t)?.as],i=e=>t.scale(e),r=t.scale("x"),a=t.scale("y"),o=i("fx")?.apply,l=i("fy")?.apply,c=Array.from(s("x"),r.apply),h=Array.from(s("y"),a.apply);if(o){const t=Tt(r.range),e=s("fx");for(let n=0;n<e.length;++n)c[n]+=o(e[n])-t}if(l){const t=Tt(a.range),e=s("fy");for(let n=0;n<e.length;++n)h[n]+=l(e[n])-t}return[c,h]}(t,n),p="y"===this.pointer?.01:1,f="x"===this.pointer?.01:1,d=_t(t);d.on("pointerenter pointerdown pointermove",(function(t){const[n,s]=zt(t,this),u=function(t,e,n,s,i,r,a){let o=a*a,l=-1;for(let a=0;a<t.length;++a){const c=i*(t[a]-n),h=r*(e[a]-s),u=c*c+h*h;u<=o&&(o=u,l=a)}return l}(c,h,n,s,p,f,r);if(u!==this.valueIndex){this.valueIndex=u;const t=u<0?void 0:o.map((t=>a[t][u]));i.update(l?!t||t.length>1?t:t[0]:e.clause(t))}})),l||(d.on("pointerleave",(()=>{i.update(e.clause(void 0))})),t.addEventListener("pointerenter",(t=>{if(!t.buttons){const t=this.channels.map((()=>0));i.activate(this.clause(t))}})))}}const un=(t,e)=>t-e;class pn{constructor(t,{x:e=new p,y:n=new p,xfield:s,yfield:i,zoom:r=!0,panx:a=!0,pany:o=!0}){this.mark=t,this.xsel=e,this.ysel=n,this.xfield=s||an(t,"x"),this.yfield=i||an(t,"y"),this.zoom=fn(r,[0,1/0],[1,1]),this.panx=this.xsel&&a,this.pany=this.ysel&&o;const{plot:l}=t;a&&this.xsel.addEventListener("value",(t=>{l.setAttribute("xDomain",t)&&l.update()})),o&&this.ysel.addEventListener("value",(t=>{l.setAttribute("yDomain",t)&&l.update()}))}publish(t){if(this.panx){const e=function(t,e){return e.range.map(t.invertX,t).map(e.invert,e)}(t,this.xscale);this.xsel.update(this.clause(e,this.xfield,this.xscale))}if(this.pany){const e=function(t,e){return e.range.map(t.invertY,t).map(e.invert,e)}(t,this.yscale);this.ysel.update(this.clause(e,this.yfield,this.yscale))}}clause(t,e,n){return o(e,t,{source:this,clients:this.mark.plot.markSet,scale:n})}init(t){if(this.svg=t,this.initialized)return;this.initialized=!0;const{panx:e,pany:n,mark:{plot:{element:s}},xsel:i,ysel:r}=this;this.xscale=t.scale("x"),this.yscale=t.scale("y");const a=this.xscale.range.slice().sort(un),o=this.yscale.range.slice().sort(un),l=fn(e,[-1/0,1/0],a),c=fn(n,[-1/0,1/0],o),h=qt().extent([[a[0],o[0]],[a[1],o[1]]]).scaleExtent(this.zoom).translateExtent([[l[0],c[0]],[l[1],c[1]]]).on("start",(()=>{this.xscale=this.svg.scale("x"),this.yscale=this.svg.scale("y")})).on("end",(()=>s.__zoom=new Dt(1,0,0))).on("zoom",(({transform:t})=>this.publish(t)));if(_t(s).call(h),e||n){let t=!1;s.addEventListener("pointerenter",(s=>{if(!t&&(t=!0,!s.buttons)){if(e){const{xscale:t,xfield:e}=this;i.activate(this.clause(t.domain,e,t))}if(n){const{yscale:t,yfield:e}=this;r.activate(this.clause(t.domain,e,t))}}})),s.addEventListener("pointerleave",(()=>t=!1))}}}function fn(t,e,n){return t?Array.isArray(t)?t:e:n}const dn={m:2,l:2,h:1,v:1,z:0,c:6,s:4,q:4,t:2,a:7},gn=/[mlhvzcsqta]([^mlhvzcsqta]+|$)/gi,mn=/^[+-]?(([0-9]*\.[0-9]+)|([0-9]+\.)|([0-9]+))([eE][+-]?[0-9]+)?/,yn=/^((\s+,?\s*)|(,\s*))/,xn=/^[01]/,bn=t=>`Invalid SVG path, incorrect parameter ${t}`;function vn(t){const e=[];return(t.match(gn)||[]).forEach((t=>{let n=t[0];const s=n.toLowerCase(),i=dn[s],r=function(t,e,n){const s=[];for(let i=0;e&&i<n.length;)for(let r=0;r<e;++r){const e="a"!==t||3!==r&&4!==r?mn:xn,a=n.slice(i).match(e);if(null===a)throw new Error(bn("type"));i+=a[0].length,s.push(+a[0]);const o=n.slice(i).match(yn);null!==o&&(i+=o[0].length)}return s}(s,i,t.slice(1).trim()),a=r.length;if(a<i||a&&a%i!=0)throw new Error(bn("count"));if(e.push([n,...r.slice(0,i)]),a!==i){"m"===s&&(n="M"===n?"L":"l");for(let t=i;t<a;t+=i)e.push([n,...r.slice(t,t+i)])}})),e}function wn(t,e,n,s,i){let[[r,a],[o,l]]=t;const{e:c,f:h}=i,u=s.getBoundingClientRect(),p=u.left-e,f=u.right-e,d=u.top-n,g=u.bottom-n;if(p>=r&&f<=o&&d>=a&&g<=l)return!0;if(p<=o&&f>=r&&d<=l&&g>=a){let t=s.tagName;if("a"===t&&(t=(s=s.children[0]).tagName),"rect"===t||"text"===t||"image"===t)return!0;switch(r-=c,a-=h,o-=c,l-=h,t){case"circle":return Rn(r,a,o,l,An(s.cx),An(s.cy),An(s.r));case"line":return Mn(r,a,o,l,An(s.x1),An(s.y1),An(s.x2),An(s.y2));case"path":return function(t,e,n,s,i){const r=i.__path__||(i.__path__=vn(i.getAttribute("d")));let a=0,o=0,l=0,c=0,h=!1,u=[0,0],p=2;const f=kn(i),d=(t,e)=>{u.length=p=2,u[0]=l=a=t,u[1]=c=o=e},g=f?(t,e)=>d(En(f,t,e),Sn(f,t,e)):(t,e)=>d(t,e),m=(i,r)=>(u[p]=i,u[p+1]=r,p+=2,Mn(t,e,n,s,u[p-4],u[p-3],i,r)),y=f?(t,e)=>{h=m(En(f,l=t,c=e),Sn(f,t,e))}:(t,e)=>{h=m(l=t,c=e)};for(let i=0;i<r.length;++i){const p=r[i];switch(p[0]){case"M":g(p[1],p[2]);break;case"m":g(l+p[1],c+p[2]);break;case"L":case"T":y(p[1],p[2]);break;case"H":y(p[1],c);break;case"V":y(l,p[1]);break;case"l":case"t":y(l+p[1],c+p[2]);break;case"h":y(l+p[1],c);break;case"v":y(l,c+p[1]);break;case"C":y(p[5],p[6]);break;case"c":y(l+p[5],c+p[6]);break;case"S":case"Q":y(p[3],p[4]);break;case"s":case"q":y(l+p[3],c+p[4]);break;case"A":y(p[6],p[7]);break;case"a":if(Ln(r,i))return Rn(t,e,n,s,l,c-p[2],p[2]);y(l+p[6],l+p[7]);break;case"z":case"Z":if(y(a,o),Fn(t,e,u)>0)return!0;g(a,o);break;default:return console.warn("SVG path command not supported: ",p[0]),!1}if(h)return!0}return!1}(r,a,o,l,s)}}return!1}function An(t){return t.baseVal.value}function kn(t){const e=t.transform.baseVal,n=e.length;let s=e[0]?.matrix;for(let t=1;t<n;++t)s=s.multiply(e[t].matrix);return s}function Rn(t,e,n,s,i,r,a){const o=t<=i&&i<=n,l=e<=r&&r<=s;if(o&&l)return!0;const c=Math.min(Math.abs(t-i),Math.abs(n-i));if(l&&c<=a)return!0;const h=Math.min(Math.abs(e-r),Math.abs(s-r));return o&&h<=a||c*c+h*h<=a*a}function Mn(t,e,n,s,i,r,a,o){const l=Math.max(Math.min(i,a),t),c=Math.min(Math.max(i,a),n);if(l>c)return!1;let h=r,u=o;const p=a-i;if(Math.abs(p)>1e-8){const t=(o-r)/p,e=r-t*i;h=t*l+e,u=t*c+e}return Math.max(Math.min(h,u),e)<=Math.min(Math.max(h,u),s)}function En(t,e,n){return t.a*e+t.c*n+t.e}function Sn(t,e,n){return t.b*e+t.d*n+t.f}function Ln(t,e){const n=t[e],s=t[e+1];return s&&"a"===s[0]&&"z"===t[e+2]?.[0]&&n[1]===n[2]&&s[1]===s[2]&&n[1]===s[1]&&n[7]===-s[7]}function Fn(t,e,n){let s=0;const i=n.length-2;for(let r=0;r<i;r+=2)n[r+1]<=e?n[r+3]>e&&On(t,e,n,r)>0&&++s:n[r+3]<=e&&On(t,e,n[r])<0&&--s;return s}function On(t,e,n,s){return(n[s+2]-n[s])*(e-n[s+1])-(t-n[s])*(n[s+3]-n[s+1])}function _n(t,e){return null==t||null==e?null!=t||null!=e:t.length!==e.length||t.some(((t,n)=>Tn(t,e[n])))}function Tn(t,e){const n=t.length;if(e.length!==n)return!0;for(let s=0;s<n;++s)if(t[s]!==e[s])return!0;return!1}class zn{constructor(t,{channels:e,selection:n,peers:s=!0,brush:i={fill:"none",stroke:"currentColor",strokeDasharray:"1,1"}}){this.mark=t,this.selection=n,this.peers=s,this.style=i&&Qe(i),this.brush=en(),this.brush.on("brush end",(t=>this.publish(t.selection))),this.extent=null,this.groups=null;const{fields:r,as:a}=function(t,e){const n=[],s=[];return e.forEach((e=>{const i="color"===e?["color","fill","stroke"]:"x"===e?["x","x1","x2"]:"y"===e?["y","y1","y2"]:[e];for(let e=0;e<i.length;++e){const r=t.channelField(i[e],{exact:!0});if(r)return n.push(rn(r.field)),void s.push(r.as)}throw new Error(`Missing channel: ${e}`)})),{fields:n,as:s}}(t,e);this.fields=r,this.as=a}reset(){this.value=void 0,this.extent=null,this.g&&this.brush.reset(this.g)}activate(){this.selection.activate(this.clause([this.fields.map((()=>0))]))}clause(t){const{fields:e,mark:n}=this;return c(e,t,{source:this,clients:this.peers?n.plot.markSet:(new Set).add(n)})}publish(t){const{as:e,group:n,mark:s,svg:i}=this;let r;if(t){const{data:{columns:a={}}={}}=s,o=new Map;(function(t,e,n){const{x:s,y:i}=t.getBoundingClientRect(),r=t.createSVGMatrix(),a=[];for(const t of e.children)if("g"===t.tagName){const e=kn(t)??r;for(const r of t.children)wn(n,s,i,r,e)&&a.push(r)}else wn(n,s,i,t,r)&&a.push(t);return a})(i,n,t).forEach((t=>{const n=He(t),s=e.map((t=>a[t][n]));o.set(s.join("|"),s)})),r=Array.from(o.values())}this.extent=t,_n(r,this.value)&&(this.value=r,this.selection.update(this.clause(r)))}init(t){const{brush:e,extent:n,mark:s,style:i}=this;this.svg=t;const r=t.width.baseVal.value,a=t.height.baseVal.value;if(e.extent([[0,0],[r,a]]),this.group=t.querySelector(`[data-index="${s.index}"]`),this.g=_t(t).append("g").attr("class","region-xy").each(Je).call(e).call(e.moveSilent,n),i){const t=this.g.selectAll("rect.selection");for(const e in i)t.attr(e,i[e])}t.addEventListener("pointerenter",(t=>{t.buttons||this.activate()}))}}class qn{constructor(t,{selection:e,channels:n,peers:s=!0}){this.value=null,this.mark=t,this.selection=e,this.peers=s;const i=this.fields=[],r=this.as=[];n.forEach((e=>{const n="color"===e?["color","fill","stroke"]:"x"===e?["x","x1","x2"]:"y"===e?["y","y1","y2"]:[e];for(let e=0;e<n.length;++e){const s=t.channelField(n[e],{exact:!0});if(s)return i.push(s.field?.basis||s.field),void r.push(s.as)}throw new Error(`Missing channel: ${e}`)}))}clause(t){const{fields:e,mark:n}=this;return c(e,t,{source:this,clients:this.peers?n.plot.markSet:(new Set).add(n)})}init(t,e,n){const{mark:s,as:i,selection:r}=this,{data:{columns:a={}}={}}=s;n??=t=>i.map((e=>a[e][He(t)])),e??=`[data-index="${s.index}"]`;const o=Array.from(t.querySelectorAll(e));t.addEventListener("pointerdown",(t=>{const e=r.single?r.value:this.value,s=t.target;let i=null;if(function(t,e){return t.some((t=>t.contains(e)))}(o,s)){const r=n(s);(t.shiftKey||t.metaKey)&&e?.length?(i=e.filter((t=>Tn(t,r))),i.length===e.length&&i.push(r)):i=1!==e?.length||Tn(e[0],r)?[r]:null}this.value=i,_n(e,i)&&r.update(this.clause(i))})),t.addEventListener("pointerenter",(t=>{t.buttons||this.selection.activate(this.clause([this.fields.map((()=>0))]))}))}}const Dn=":scope > div, :scope > span",In="swatch",Pn="ramp";class $n{constructor(t,e){const{as:n,field:s,...i}=e;this.channel=t,this.options=i,this.type=null,this.handler=null,this.selection=n,this.field=s,this.legend=null,this.element=document.createElement("div"),this.element.setAttribute("class","legend"),Object.defineProperty(this.element,"value",{value:this})}setPlot(t){this.plot=t}init(t){const e=function(t,e){const{channel:n,plot:s,selection:i}=t,r=e.scale(n),a="ordinal"===r.type?In:Pn,o={label:s.getAttribute(`${n}Label`)??null,...t.options},l=a===In?o:o.label?{tickSize:2,...o}:{tickSize:2,marginTop:1,height:29,...o},c=e.legend(n,l);t.legend=c;let h=!!i;if(h&&a===Pn){const t=l.width??240,e=Cn(r,t);e?c.scale=function(s){return"x"===s?{range:[0,t]}:"y"===s?{range:[-10,0]}:s===n?e:void 0}:h=!1}if(h){const e=function(t,e){const{channel:n,handler:s,selection:i}=t;if(s)return s;const r=function(t){const{channel:e,plot:n}=t,s=t.field??function(t,e){const n="color"===e?["fill","stroke"]:"opacity"===e?["opacity","fillOpacity","strokeOpacity"]:null;if(null==n)return null;for(let e=t.length-1;e>-1;--e)for(const s of n){const n=t[e].channelField(s,{exact:!0});if(n)return n.field}return null}(n.marks,e)??"value";if(s){const t={field:s};return{plot:n,channelField:n=>e===n?t:void 0}}}(t);e===In?(t.handler=new qn(r,{selection:i,channels:[n],peers:!1}),i.addEventListener("value",(()=>t.update()))):t.handler=new ln(r,{selection:i,channel:n,brush:{fill:"none",stroke:"currentColor"},peers:!1});return t.handler}(t,a);a===In?(e.init(c,Dn,(t=>[t.__data__])),t.update()):e.init(c,c.querySelector("g:last-of-type"))}return c}(this,t);return this.element.replaceChildren(e),this.element}update(){if(!this.legend)return;const{selection:t,handler:e}=this,{single:n,value:s}=t,i=n?s:t.valueFor(e),r=i&&i.length?new Set(i.map((t=>t[0]))):null,a=this.legend.querySelectorAll(Dn);for(const t of a){const e=!r||r.has(t.__data__);t.style.opacity=e?1:.2}}}function Cn(t,e){const{apply:n,invert:s,interpolate:i,...r}=t;let a,o=t.type;switch(o.startsWith("diverging-")&&(o=o.slice(11)),o){case"log":case"pow":case"sqrt":case"symlog":a=o;break;case"threshold":case"quantize":case"quantile":return console.warn(`Legends do not yet support ${o} scales.`),null;default:a="linear"}return y({x:{...r,type:a,range:[0,e]}})}function Nn(t,e,n=0,s=Math.LN10){let i;const r=Math.ceil(Math.log(e)/s);let a=Math.max(n,Math.pow(10,Math.round(Math.log(t)/s)-r));for(;Math.ceil(t/a)>e;)a*=10;const o=[5,2];for(let s=0,r=o.length;s<r;++s)i=a/o[s],i>=n&&t/i<=e&&(a=i);return a}const jn="year",Wn="month",Bn="hour",Gn="minute",Un="second",Xn=1e3,Vn=6e4,Yn=36e5,Hn=864e5,Zn=2592e6,Qn=31536e6,Kn=[[Un,1,Xn],[Un,5,5e3],[Un,15,15e3],[Un,30,3e4],[Gn,1,Vn],[Gn,5,3e5],[Gn,15,9e5],[Gn,30,18e5],[Bn,1,Yn],[Bn,3,108e5],[Bn,6,216e5],[Bn,12,432e5],["day",1,Hn],["day",7,6048e5],[Wn,1,Zn],[Wn,3,7776e6],[jn,1,Qn]];const Jn=new Set(["rectY-x","rectX-y","rect-x","rect-y","ruleY-x","ruleX-y"]);function ts(t,e={}){const n=(n,s)=>function(t,e){return Jn.has(`${t.type}-${e}`)}(n,s)?{[`${s}1`]:es(n,s,t,e),[`${s}2`]:es(n,s,t,{...e,offset:1})}:{[s]:es(n,s,t,e)};return n[Ct]=!0,n}function es(t,e,n,s){return new ns(n,t,e,s)}class ns extends gt{constructor(t,e,n,s){super("COLUMN_REF"),this.column=t,this.mark=e,this.channel=n,this.options=s}get stats(){return{column:this.column,stats:["min","max"]}}toString(){const{mark:t,channel:e,column:n,options:s}=this,{type:i,min:r,max:a}=t.channelField(e),{interval:o,steps:l,offset:c=0}=s,h=o??("date"===i||function(t,e){const n=t.plot.getAttribute(`${e}Scale`);return"utc"===n||"time"===n}(t,e)?"date":"number");let u;if("number"===h){const{apply:i,sqlApply:o,sqlInvert:l}=ae(t,e),h=function(t,e,n){let{step:s,steps:i,minstep:r=0,nice:a=!0}=n;if(!1!==a){const n=e-t,a=Math.LN10;s=s||Nn(n,i||25,r,a);let o=Math.log(s);const l=o>=0?0:1+~~(-o/a),c=Math.pow(10,-l-1);o=Math.floor(t/s+c)*s,t=t<o?o-s:o,e=Math.ceil(e/s)*s,i=Math.round((e-t)/s)}return{min:t,max:e,steps:i}}(i(r),i(a),s),p=o(n),f=V((h.max-h.min)/h.steps),d=mt(B(0===h.min?p:Q(p,h.min),f));u=l(Y(h.min,H(f,c?Y(c,d):d)))}else{const{interval:t,step:e=1}="date"===h?function(t,e,n){const s=e-t,i=s/n;let r=It((t=>t[2])).right(Kn,i);return r===Kn.length?{interval:jn,step:Nn(s/Qn,n)}:r?(r=Kn[i/Kn[r-1][2]<Kn[r][2]/i?r-1:r],{interval:r[0],step:r[1]}):{interval:"millisecond",step:Nn(s,n,1)}}(r,a,l||40):s,i=yt(n,t,e);u=c?Y(i,xt(t,c*e)):i}return`${u}`}}export{ge as ConnectedMark,Re as ContourMark,ze as DenseLineMark,De as Density1DMark,Pe as Density2DMark,We as ErrorBarMark,Pt as Fixed,Be as GeoMark,ke as Grid2DMark,Oe as HeatmapMark,Ge as HexbinMark,Ke as Highlight,ln as Interval1D,cn as Interval2D,$n as Legend,ne as Mark,hn as Nearest,pn as PanZoom,Yt as Plot,Fe as RasterMark,Ue as RasterTileMark,zn as Region,Ve as RegressionMark,qn as Toggle,Ct as Transform,$t as Transient,ts as bin};export default null;
