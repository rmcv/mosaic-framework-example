/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.37.0.
 * Original file: /npm/@uwdata/mosaic-core@0.12.2/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{tableFromIPC as e}from"../flechette@1.1.1/_esm.js";import{sql as t,pow as r,sqrt as n,sum as s,div as i,mul as c,max as o,argmax as u,min as a,argmin as l,sub as h,regrCount as f,isNotNull as p,regrAvgX as d,regrAvgY as g,and as m,count as y,isSelectQuery as v,isAggregateExpression as _,collectAggregates as w,rewrite as q,isTableRef as b,createTable as x,collectColumns as E,asNode as S,isBetween as A,scaleTransform as C,int32 as T,Query as k,floor as R,float64 as I,ceil as L,round as M,isNode as j,asTableRef as N,isNull as $,isColumnRef as O,isDescribeQuery as P,literal as B,or as U,isIn as z,isNotDistinct as D,contains as G,prefix as F,suffix as Q,regexp_matches as W}from"../mosaic-sql@0.12.2/_esm.js";import*as H from"../../@duckdb/duckdb-wasm@1.28.0/_esm.js";const Y={};function J(e,t=!1){let r,n,s=Y;function i(t){r=e(t).catch((()=>{})).finally((()=>{if(n){const{value:e}=n;n=null,i(e)}else r=null}))}function c(e){r?function(e){n={event:e}}(e):i(e)}return t?function(e){s!==e&&requestAnimationFrame((()=>{const e=s;s=Y,c(e)})),s=e}:c}class V{constructor(e){this._filterBy=e,this._requestUpdate=J((()=>this.requestQuery()),!0),this._coordinator=null}get coordinator(){return this._coordinator}set coordinator(e){this._coordinator=e}get filterBy(){return this._filterBy}get filterStable(){return!0}fields(){return null}fieldInfo(e){return this}query(e){return null}queryPending(){return this}queryResult(e){return this}queryError(e){return this}requestQuery(e){const t=e||this.query(this.filterBy?.predicate(this));return this._coordinator.requestQuery(this,t)}requestUpdate(){this._requestUpdate()}initialize(){return this._coordinator.initializeClient(this)}update(){return this}}function X(t){return e(t,{useDate:!0})}function Z(e="ws://localhost:3000/"){const t=[];let r,n=!1,s=null;const i={open(){n=!0,o()},close(){for(n=!1,s=null,r=null;t.length;)t.shift().reject("Socket closed")},error(e){if(s){const{reject:t}=s;s=null,o(),t(e)}else console.error("WebSocket error: ",e)},message({data:e}){if(s){const{query:t,resolve:r,reject:n}=s;if(s=null,o(),"string"==typeof e){const t=JSON.parse(e);t.error?n(t.error):r(t)}else if("exec"===t.type)r();else{if("arrow"!==t.type)throw new Error(`Unexpected socket data: ${e}`);r(X(e))}}else console.log("WebSocket message: ",e)}};function c(c,u,a){null==r&&function(){r=new WebSocket(e),r.binaryType="arraybuffer";for(const e in i)r.addEventListener(e,i[e])}(),t.push({query:c,resolve:u,reject:a}),n&&!s&&o()}function o(){t.length&&(s=t.shift(),r.send(JSON.stringify(s.query)))}return{get connected(){return n},query:e=>new Promise(((t,r)=>c(e,t,r)))}}function K(e){let t=2166136261;for(let r=0,n=e.length;r<n;++r){const n=e.charCodeAt(r),s=65280&n;s&&(t=ee(t^s>>8)),t=ee(t^255&n)}return function(e){return e+=e<<13,e^=e>>>7,e+=e<<3,e^=e>>>17,e+=e<<5,4294967295&e}(t)>>>0}function ee(e){return e+(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24)}function te(e,f,p){switch(e.name){case"count":case"sum":return function(e,t){return s(ne(e,t))}(f,e);case"avg":return function(e,t){const r=ne(e,t),{expr:n,name:o}=se(e,t);return i(s(c(r,o)),n)}(f,e);case"arg_max":return function(e,t){const r=ne(e,t),n=ne(e,o(t.args[1]),t);return u(r,n)}(f,e);case"arg_min":return function(e,t){const r=ne(e,t),n=ne(e,a(t.args[1]),t);return l(r,n)}(f,e);case"variance":case"var_samp":return ie(f,e,p);case"var_pop":return ie(f,e,p,!1);case"stddev":case"stddev_samp":return n(ie(f,e,p));case"stddev_pop":return n(ie(f,e,p,!1));case"covar_samp":return ce(f,e,p);case"covar_pop":return ce(f,e,p,!1);case"corr":return oe(f,e,p);case"regr_count":return ue(f,e).expr;case"regr_avgx":return fe(f,e);case"regr_avgy":return pe(f,e);case"regr_syy":return de(f,0,e,p);case"regr_sxx":return de(f,1,e,p);case"regr_sxy":return ce(f,e,p,null);case"regr_slope":return ge(f,e,p);case"regr_intercept":return function(e,t,r){const n=fe(e,t),s=pe(e,t),i=ge(e,t,r);return h(s,c(i,n))}(f,e,p);case"regr_r2":return r(oe(f,e,p),2);case"max":case"min":case"bit_and":case"bit_or":case"bit_xor":case"bool_and":case"bool_or":case"product":{const r=re(e);return f[r]=e,t`${e.name}("${r}")`}default:return null}}function re(e){return"pre_"+K(`${e}`).toString(16)}function ne(e,t,r){const n=r?.filter;n&&(t=t.filter?t.where(m(n,t.filter)):t.where(n));const s=re(t);return e[s]=t,s}function se(e,t){const r=ne(e,y(t.args[0]),t);return{expr:s(r),name:r}}function ie(e,t,n,c=!0){const o=t.args[0],{expr:u}=se(e,t),a=h(o,n(o)),l=ne(e,s(r(a,2)),t),f=ne(e,s(a),t),p=c?h(u,1):u;return i(h(s(l),i(r(s(f),2),u)),p)}function ce(e,t,r,n=!0){const{expr:s}=ue(e,t),o=he(e,t,r),u=ae(e,1,t,r),a=ae(e,0,t,r),l=h(o,i(c(u,a),s));return null===n?l:i(l,n?h(s,1):s)}function oe(e,t,s){const{expr:o}=ue(e,t),u=he(e,t,s),a=le(e,1,t,s),l=le(e,0,t,s),f=ae(e,1,t,s),p=ae(e,0,t,s),d=h(a,i(r(f,2),o)),g=h(l,i(r(p,2),o));return i(h(u,i(c(f,p),o)),n(c(d,g)))}function ue(e,t){const[r,n]=t.args,i=ne(e,f(r,n),t);return{expr:s(i),name:i}}function ae(e,t,r,n){const i=r.args,c=i[t],o=i[1-t],u=s(h(c,n(c))).where(p(o));return s(ne(e,u,r))}function le(e,t,n,i){const c=n.args,o=c[t],u=c[1-t],a=s(r(h(o,i(o)),2)).where(p(u));return s(ne(e,a,n))}function he(e,t,r){const[n,i]=t.args,o=s(c(h(i,r(i)),h(n,r(n))));return s(ne(e,o,t))}function fe(e,t){const[r,n]=t.args,{expr:o,name:u}=ue(e,t),a=ne(e,d(r,n),t);return i(s(c(a,u)),o)}function pe(e,t){const[r,n]=t.args,{expr:o,name:u}=ue(e,t),a=ne(e,g(r,n),t);return i(s(c(a,u)),o)}function de(e,t,n,s){const{expr:c}=ue(e,n),o=ae(e,t,n,s),u=le(e,t,n,s);return h(u,i(r(o,2),c))}function ge(e,t,r){const n=ce(e,t,r,null),s=de(e,1,t,r);return i(n,s)}function me(e,t){const r=e.subqueries;if(v(e)&&0===r.length)return t(e);const n=me(r[0],t);for(let e=1;e<r.length;++e){const s=me(r[e],t);if(void 0!==s&&s!==n)return NaN}return n}const ye={skip:!0,result:null};class ve{constructor(e,{schema:t="mosaic",enabled:r=!0}={}){this.entries=new Map,this.active=null,this.mc=e,this._schema=t,this._enabled=r}set enabled(e){this._enabled!==e&&(e||this.clear(),this._enabled=e)}get enabled(){return this._enabled}set schema(e){this._schema!==e&&(this.clear(),this._schema=e)}get schema(){return this._schema}dropSchema(){return this.clear(),this.mc.exec(`DROP SCHEMA IF EXISTS "${this.schema}" CASCADE`)}clear(){this.entries.clear(),this.active=null}request(e,r,n){if(!this.enabled)return null;const{entries:s,mc:i,schema:o}=this,{source:u}=n;if(!u)return null;if(this.active&&(this.active.source!==u&&this.clear(),null===this.active?.source))return null;let{active:a}=this;if(!a&&(this.active=a=function(e){const{source:t,meta:r}=e,n=e.predicate,s=E(n).map((e=>e.column));let i,o;if(!r||!s)return{source:null,columns:o,predicate:i};const{type:u,scales:a,bin:l,pixelSize:f=1}=r;if("point"===u)i=e=>e,o=Object.fromEntries(s.map((e=>[`${e}`,S(e)])));else if("interval"===u&&a){const e=a.map((e=>function(e,t,r){const{type:n,domain:s,range:i,apply:o,sqlApply:u}=C(e);if(!o)return;const a=_e[`${r}`.toLowerCase()]||R,l=o(Math.min(...s)),f=o(Math.max(...s)),p=("identity"===n?1:Math.abs(i[1]-i[0])/(f-l))/t,d=1===p?e=>e:e=>c(I(p),e),g=0===l?e=>e:e=>h(e,I(l));return e=>T(a(d(g(u(e)))))}(e,f,l)));e.some((e=>!e))||(1===e.length?(i=t=>t?A("active0",t.extent.map(e[0])):[],o={active0:e[0](n.expr)}):(i=t=>t?m(t.clauses.map(((t,r)=>A(`active${r}`,t.extent.map(e[r]))))):[],o=Object.fromEntries(n.clauses.map(((t,r)=>[`active${r}`,e[r](t.expr)])))))}return{source:o?t:null,columns:o,predicate:i}}(n),null===a.source))return null;if(s.has(e))return s.get(e);const l=function(e){if(!e.filterStable)return null;const r=e.query();if(!v(r))return null;const n=me(r,(e=>{const t=e._from[0]?.expr;return b(t)?t.name:t}));if("string"!=typeof n)return null;const s=new Map,i={},c={},o=[],u=e=>{const s=e.column,i=me(r,(e=>e._select.find((e=>e.alias===s))?.expr));return t`(SELECT avg(${i??e}) FROM "${n}")`};for(const{alias:e,expr:t}of r._select){if(_(t)>1)return null;const r=w(t);if(0===r.length)o.push(e),i[e]=t;else{for(const e of r){if(e.isDistinct)return null;const t=te(e,i,u);if(!t)return null;s.set(e,t)}c[e]=q(t,s)}}return s.size?{group:o,preagg:i,output:c}:null}(e);let f;if(l)if(r.skip(e,n))f=ye;else{const t=r.remove(u).predicate(e);f=function(e,t,r,n){const{group:s,output:i,preagg:c}=r,{columns:o}=t,u=e.setSelect({...c,...o}).groupby(Object.keys(o)),[a]=u.subqueries;if(a){!function(e,t){const r=new Set,n=e=>{r.has(e)||(r.add(e),v(e)&&e._from.length&&e.select(t),e.subqueries.forEach(n))};n(e)}(a,Object.values(o).flatMap((e=>E(e).map((e=>e.column)))))}const l=u._having,h=u._orderby;u._having=[],u._orderby=[];const f=u.toString(),p=(K(f)>>>0).toString(16),d=`${n}.preagg_${p}`,g=k.select(s,i).from(d).groupby(s).having(l).orderby(h);return new we({table:d,create:f,active:t,select:g})}(e.query(t),a,l,o),f.result=i.exec([`CREATE SCHEMA IF NOT EXISTS ${o}`,x(f.table,f.create,{temp:!1})]),f.result.catch((e=>i.logger().error(e)))}else f=null;return s.set(e,f),f}}const _e={ceil:L,round:M};class we{constructor({table:e,create:t,active:r,select:n}){this.table=e,this.create=t,this.result=null,this.active=r,this.select=n,this.skip=!1}query(e){return this.select.clone().where(this.active.predicate(e))}}function qe(e){switch(e){case"BIGINT":case"HUGEINT":case"INTEGER":case"SMALLINT":case"TINYINT":case"UBIGINT":case"UINTEGER":case"USMALLINT":case"UTINYINT":case"DOUBLE":case"FLOAT":case"REAL":return"number";case"DATE":case"TIMESTAMP":case"TIMESTAMPTZ":case"TIMESTAMP WITH TIME ZONE":case"TIME":case"TIMESTAMP_NS":return"date";case"BOOLEAN":return"boolean";case"VARCHAR":case"UUID":case"JSON":return"string";case"ARRAY":case"LIST":return"array";case"BLOB":case"STRUCT":case"MAP":case"GEOMETRY":return"object";default:if(e.startsWith("DECIMAL"))return"number";if(e.startsWith("STRUCT")||e.startsWith("MAP"))return"object";if(e.endsWith("]"))return"array";throw new Error(`Unsupported type: ${e}`)}}const be="count",xe="nulls",Ee="max",Se="min",Ae="distinct",Ce={[be]:y,[Ae]:e=>y(e).distinct(),[Ee]:o,[Se]:a,[xe]:e=>y().where($(e))};async function Te(e,r){return 1===r.length&&"*"===r[0].column?async function(e,t){const r=Array.from(await e.query(`DESCRIBE ${N(t)}`));return r.map((e=>({table:t,column:e.column_name,sqlType:e.column_type,type:qe(e.column_type),nullable:"YES"===e.null})))}(e,r[0].table):(await Promise.all(r.map((r=>async function(e,{table:r,column:n,stats:s}){const i=k.from({source:r}).select({column:n}).groupby(j(n)&&_(n)?t`ALL`:[]),[c]=Array.from(await e.query(k.describe(i))),o={table:r,column:`${n}`,sqlType:c.column_type,type:qe(c.column_type),nullable:"YES"===c.null};if(!s?.length)return o;const[u]=await e.query(function({table:e,column:t,stats:r}){return k.from(e).select(Array.from(r,(e=>({[e]:Ce[e](t)}))))}({table:r,column:n,stats:s}),{persist:!0});return Object.assign(o,u)}(e,r))))).filter((e=>e))}const ke=Object.freeze({pending:Symbol("pending"),ready:Symbol("ready"),error:Symbol("error"),done:Symbol("done")});class Re extends Promise{constructor(){let e,t;super(((r,n)=>{e=r,t=n})),this._resolve=e,this._reject=t,this._state=ke.pending,this._value=void 0}fulfill(e){if(void 0!==this._value){if(void 0!==e)throw Error("Promise is ready and fulfill has a provided value");this._resolve(this._value)}else{if(void 0===e)throw Error("Promise is neither ready nor has provided value");this._resolve(e)}return this._state=ke.done,this}ready(e){return this._state=ke.ready,this._value=e,this}reject(e){return this._state=ke.error,this._reject(e),this}get state(){return this._state}}function Ie(){return{debug(...e){},info(...e){},log(...e){},warn(...e){},error(...e){}}}function Le(e,t){let r=[],n=0;function s(){const s=function(e,t){const r=[],n=new Map;for(const s of e){const{entry:{request:e}}=s,i=Me(e.query,t);if(!n.has(i)){const e=[];r.push(e),n.set(i,e)}n.get(i).push(s)}return r}(r,t);r=[],n=0;for(const r of s)je(r,e),$e(r,t)}return{add(t,i){"arrow"===t.request.type?(n=n||("undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:setTimeout)((()=>s())),r.push({entry:t,priority:i,index:r.length})):e(t,i)}}}function Me(e,t){const r=`${e}`;if(v(e)&&!t.get(r)){if(e._orderby.length||e._where.length||e._qualify.length||e._having.length)return r;const t=e.clone().setSelect("*"),n=e._groupby;if(n.length){const r={};e._select.forEach((({alias:e,expr:t})=>r[e]=t)),t.setGroupby(n.map((e=>O(e)&&r[e.column]||e)))}else e._select.some((e=>_(e.expr)))&&t.setGroupby("ALL");return`${t}`}return r}function je(e,t){if(function(e){if(e.length>1){const t=`${e[0].entry.request.query}`;for(let r=1;r<e.length;++r)if(t!==`${e[r].entry.request.query}`)return!0}return!1}(e))t({request:{type:"arrow",cache:!1,query:e.query=Ne(e)},result:e.result=new Re});else for(const{entry:r,priority:n}of e)t(r,n)}function Ne(e){const t=e.maps=[],r=new Map;for(const n of e){const{query:e}=n.entry.request,s=[];t.push(s);for(const{alias:t,expr:n}of e._select){const e=`${n}`;r.has(e)||r.set(e,[`col${r.size}`,n]);const[i]=r.get(e);s.push([i,t])}}const n=e[0].entry.request.query.clone(),s=n._groupby;if(s.length){const t={};e.maps[0].forEach((([e,r])=>t[r]=e)),n.setGroupby(s.map((e=>O(e)&&t[e.column]||e)))}return n.setSelect(Array.from(r.values()))}async function $e(e,t){const{maps:r,query:n,result:s}=e;if(!r)return;let i;try{i=await s}catch(t){for(const{entry:r}of e)r.result.reject(t);return}const c=P(n);e.forEach((({entry:e},n)=>{const{request:s,result:o}=e,u=r[n],a=c&&u?function(e,t){const r=new Map(t),n=[];for(const t of e)r.has(t.column_name)&&n.push({...t,column_name:r.get(t.column_name)});return n}(i,u):u?function(e,t){return e.select(t.map((e=>e[0])),t.map((e=>e[1])))}(i,u):i;s.cache&&t.set(String(s.query),a),o.fulfill(a)}))}Re.prototype.constructor=Promise;const Oe="undefined"!=typeof requestIdleCallback?requestIdleCallback:setTimeout;class Pe{constructor(e){this.queue=Array.from({length:e},(()=>({head:null,tail:null})))}isEmpty(){return this.queue.every((e=>!e.head))}insert(e,t){const r=this.queue[t];if(!r)throw new Error(`Invalid queue priority rank: ${t}`);const n={item:e,next:null};null===r.head?r.head=r.tail=n:r.tail=r.tail.next=n}remove(e){for(const t of this.queue){let{head:r,tail:n}=t;for(let t=null,s=r;s;t=s,s=s.next)e(s.item)&&(s===r?r=s.next:t.next=s.next,s===n&&(n=t||r));t.head=r,t.tail=n}}next(){for(const e of this.queue){const{head:t}=e;if(null!==t)return e.head=t.next,e.tail===t&&(e.tail=null),t.item}}}const Be=Object.freeze({High:0,Normal:1,Low:2});class Ue{constructor(e=32){this.queue=new Pe(3),this.db=null,this.clientCache=null,this._logger=Ie(),this._logQueries=!1,this._consolidate=null,this.pendingResults=[],this.maxConcurrentRequests=e,this.pendingExec=!1}next(){if(this.queue.isEmpty()||this.pendingResults.length>this.maxConcurrentRequests||this.pendingExec)return;const{request:e,result:t}=this.queue.next();this.pendingResults.push(t),"exec"===e.type&&(this.pendingExec=!0),this.submit(e,t).finally((()=>{for(;this.pendingResults.length&&this.pendingResults[0].state!==ke.pending;){const e=this.pendingResults.shift();e.state===ke.ready?e.fulfill():e.state===ke.done&&this._logger.warn("Found resolved query in pending results.")}"exec"===e.type&&(this.pendingExec=!1),this.next()}))}enqueue(e,t=Be.Normal){this.queue.insert(e,t),this.next()}async submit(e,t){try{const{query:r,type:n,cache:s=!1,options:i}=e,c=r?`${r}`:null;if(s){const e=this.clientCache.get(c);if(e){const r=await e;return this._logger.debug("Cache"),void t.ready(r)}}const o=performance.now();this._logQueries&&this._logger.debug("Query",{type:n,sql:c,...i});const u=this.db.query({type:n,sql:c,...i});s&&this.clientCache.set(c,u);const a=await u;s&&this.clientCache.set(c,a),this._logger.debug(`Request: ${(performance.now()-o).toFixed(1)}`),t.ready("exec"===n?null:a)}catch(e){t.reject(e)}}cache(e){return void 0!==e?this.clientCache=!0===e?function({max:e=1e3,ttl:t=108e5}={}){let r=new Map;function n(){const e=performance.now()-t;let n=null,s=1/0;for(const[t,i]of r){const{last:c}=i;c<s&&(n=t,s=c),e>c&&r.delete(t)}n&&r.delete(n)}return{get(e){const t=r.get(e);if(t)return t.last=performance.now(),t.value},set:(t,s)=>(r.set(t,{last:performance.now(),value:s}),r.size>e&&Oe(n),s),clear(){r=new Map}}}():e||{get:()=>{},set:(e,t)=>t,clear:()=>{}}:this.clientCache}logger(e){return e?this._logger=e:this._logger}logQueries(e){return void 0!==e?this._logQueries=!!e:this._logQueries}connector(e){return e?this.db=e:this.db}consolidate(e){e&&!this._consolidate?this._consolidate=Le(this.enqueue.bind(this),this.clientCache):!e&&this._consolidate&&(this._consolidate=null)}request(e,t=Be.Normal){const r=new Re,n={request:e,result:r};return this._consolidate?this._consolidate.add(n,t):this.enqueue(n,t),r}cancel(e){const t=new Set(e);if(t.size){this.queue.remove((({result:e})=>!!t.has(e)&&(e.reject("Canceled"),!0)));for(const e of this.pendingResults)t.has(e)&&e.reject("Canceled")}}clear(){this.queue.remove((({result:e})=>(e.reject("Cleared"),!0)));for(const e of this.pendingResults)e.reject("Cleared");this.pendingResults=[]}}let ze;function De(e){return e?ze=e:null==ze&&(ze=new Ge),ze}class Ge{constructor(e=Z(),{logger:t=console,manager:r=new Ue,cache:n=!0,consolidate:s=!0,preagg:i={}}={}){this.manager=r,this.manager.cache(n),this.manager.consolidate(s),this.databaseConnector(e),this.logger(t),this.clear(),this.preaggregator=new ve(this,i)}clear({clients:e=!0,cache:t=!0}={}){this.manager.clear(),e&&(this.filterGroups?.forEach((e=>e.disconnect())),this.filterGroups=new Map,this.clients?.forEach((e=>this.disconnect(e))),this.clients=new Set),t&&this.manager.cache().clear()}databaseConnector(e){return this.manager.connector(e)}logger(e){return arguments.length&&(this._logger=e||Ie(),this.manager.logger(this._logger)),this._logger}cancel(e){this.manager.cancel(e)}exec(e,{priority:t=Be.Normal}={}){return e=Array.isArray(e)?e.filter((e=>e)).join(";\n"):e,this.manager.request({type:"exec",query:e},t)}query(e,{type:t="arrow",cache:r=!0,priority:n=Be.Normal,...s}={}){return this.manager.request({type:t,query:e,cache:r,options:s},n)}prefetch(e,t={}){return this.query(e,{...t,cache:!0,priority:Be.Low})}createBundle(e,t,r=Be.Low){const n={name:e,queries:t.map((e=>"string"==typeof e?{sql:e}:e))};return this.manager.request({type:"create-bundle",options:n},r)}loadBundle(e,t=Be.High){const r={name:e};return this.manager.request({type:"load-bundle",options:r},t)}updateClient(e,t,r=Be.Normal){return e.queryPending(),this.query(t,{priority:r}).then((t=>e.queryResult(t).update()),(t=>{this._logger.error(t),e.queryError(t)})).catch((e=>this._logger.error(e)))}requestQuery(e,t){return this.preaggregator.clear(),t?this.updateClient(e,t):Promise.resolve(e.update())}async connect(e){const{clients:t}=this;if(t.has(e))throw new Error("Client already connected.");t.add(e),e.coordinator=this,this.initializeClient(e),function(e,t,r){if(!t)return;let n=e.filterGroups.get(t);if(!n){const r=r=>function(e,t,r){const{preaggregator:n,filterGroups:s}=e,{clients:i}=s.get(t);for(const e of i)n.request(e,t,r)}(e,t,r),s=()=>function(e,t){const{preaggregator:r,filterGroups:n}=e,{clients:s}=n.get(t),{active:i}=t;return Promise.allSettled(Array.from(s,(n=>{const s=r.request(n,t,i),c=s?null:t.predicate(n);if(s?.skip||!s&&!c)return;const o=s?.query(i.predicate)??n.query(c);return e.updateClient(n,o)})))}(e,t);t.addEventListener("activate",r),t.addEventListener("value",s),n={selection:t,clients:new Set,disconnect(){t.removeEventListener("activate",r),t.removeEventListener("value",s)}},e.filterGroups.set(t,n)}n.clients.add(r)}(this,e.filterBy,e)}async initializeClient(e){const t=e.fields();return t?.length&&e.fieldInfo(await Te(this,t)),e.requestQuery()}disconnect(e){const{clients:t,filterGroups:r}=this;if(!t.has(e))return;t.delete(e),e.coordinator=null;const n=r.get(e.filterBy);n&&n.clients.delete(e)}}class Fe{constructor(){this._callbacks=new Map}addEventListener(e,t){this._callbacks.has(e)||this._callbacks.set(e,{callbacks:new Set,pending:null,queue:new Qe});this._callbacks.get(e).callbacks.add(t)}removeEventListener(e,t){const r=this._callbacks.get(e);r&&r.callbacks.delete(t)}willEmit(e,t){return t}emitQueueFilter(e,t){return null}cancel(e){const t=this._callbacks.get(e);t?.queue.clear()}async pending(e){await(this._callbacks.get(e)?.pending)}emit(e,t){const r=this._callbacks.get(e)||{};if(r.pending)r.queue.enqueue(t,this.emitQueueFilter(e,t));else{const n=this.willEmit(e,t),{callbacks:s,queue:i}=r;if(s?.size){const t=Array.from(s,(e=>e(n)));r.pending=Promise.allSettled(t).then((()=>{r.pending=null,i.isEmpty()||this.emit(e,i.dequeue())}))}}}}class Qe{constructor(){this.clear()}clear(){this.next=null}isEmpty(){return!this.next}enqueue(e,t){const r={value:e};if(t&&this.next){let e=this;for(;e.next;)t(e.next.value)?e=e.next:e.next=e.next.next;e.next=r}else this.next=r}dequeue(){const{next:e}=this;return this.next=e?.next,e?.value}}function We(e,t){return e!==t&&(e instanceof Date&&t instanceof Date?+e!=+t:!Array.isArray(e)||!Array.isArray(t)||function(e,t){if(e.length!==t.length)return!0;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!0;return!1}(e,t))}function He(e){return e instanceof Ye}class Ye extends Fe{constructor(e){super(),this._value=e}static value(e){return new Ye(e)}static array(e){if(e.some((e=>He(e)))){const t=new Ye,r=()=>{t.update(e.map((e=>He(e)?e.value:e)))};return r(),e.forEach((e=>He(e)?e.addEventListener("value",r):0)),t}return new Ye(e)}get value(){return this._value}update(e,{force:t}={}){return We(this._value,e)||t?this.emit("value",e):this.cancel("value"),this}willEmit(e,t){return"value"===e&&(this._value=t),t}}function Je(e){return e instanceof Xe}function Ve(e,t){return new Xe(new Ze(e),t?[t].flat():t)}class Xe extends Ye{static intersect({cross:e=!1,empty:t=!1,include:r=[]}={}){return Ve({cross:e,empty:t},r)}static union({cross:e=!1,empty:t=!1,include:r=[]}={}){return Ve({cross:e,empty:t,union:!0},r)}static single({cross:e=!1,empty:t=!1,include:r=[]}={}){return Ve({cross:e,empty:t,single:!0},r)}static crossfilter({empty:e=!1,include:t=[]}={}){return Ve({cross:!0,empty:e},t)}constructor(e=new Ze,t=[]){if(super([]),this._resolved=this._value,this._resolver=e,this._relay=new Set,Array.isArray(t))for(const e of t)e._relay.add(this)}clone(){const e=new Xe(this._resolver);return e._value=e._resolved=this._value,e}remove(e){const t=this.clone();return t._value=t._resolved=t._resolver.resolve(this._resolved,{source:e}),t._value.active={source:e},t}get resolver(){return this._resolver}get single(){return this._resolver.single}get clauses(){return super.value}get active(){return this.clauses.active}get value(){return this.active?.value}valueFor(e){return this.clauses.find((t=>t.source===e))?.value}activate(e){this.emit("activate",e),this._relay.forEach((t=>t.activate(e)))}update(e){return this._resolved=this._resolver.resolve(this._resolved,e,!0),this._resolved.active=e,this._relay.forEach((t=>t.update(e))),super.update(this._resolved)}willEmit(e,t){return"value"===e?(this._value=t,this.value):t}emitQueueFilter(e,t){return"value"===e?this._resolver.queueFilter(t):null}skip(e,t){return this._resolver.skip(e,t)}predicate(e,t=!1){const{clauses:r}=this,n=t?null:r.active;return this._resolver.predicate(r,n,e)}}class Ze{constructor({union:e,cross:t,single:r,empty:n}={}){this.union=!!e,this.cross=!!t,this.single=!!r,this.empty=!!n}resolve(e,t,r=!1){const{source:n,predicate:s}=t,i=e.filter((e=>n!==e.source)),c=this.single?[]:i;return this.single&&r&&i.forEach((e=>e.source?.reset?.())),s&&c.push(t),c}skip(e,t){return this.cross&&t?.clients?.has(e)}predicate(e,t,r){const{empty:n,union:s}=this;if(n&&!e.length)return[B(!1)];if(this.skip(r,t))return;const i=e.filter((e=>!this.skip(r,e))).map((e=>e.predicate));return s&&i.length>1?U(i):i}queueFilter(e){if(this.cross){const t=e.active?.source;return e=>e.active?.source!==t}return null}}function Ke(e="http://localhost:3000/"){return{async query(t){const r=fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return"exec"===t.type?r:"arrow"===t.type?X(await(await r).arrayBuffer()):(await r).json()}}}function et(e={}){const{duckdb:t,connection:r,...n}=e;let s,i=t,c=r;function o(){return s||(s=(i?Promise.resolve(i):tt(n).then((e=>i=e))).then((e=>e.connect())).then((e=>c=e))),s}async function u(){return c||await o(),c}return{getDuckDB:async function(){return i||await o(),i},getConnection:u,query:async e=>{const{type:t,sql:r}=e,n=await u(),s=await function(e,t){return new Promise(((r,n)=>{e.useUnsafe((async(e,s)=>{try{const n=await e.runQuery(s,t);r(n)}catch(e){n(e)}}))}))}(n,r);return"exec"===t?void 0:"arrow"===t?X(s):X(s).toArray()}}}async function tt({log:e=!1}={}){const t=H.getJsDelivrBundles(),r=await H.selectBundle(t),n=URL.createObjectURL(new Blob([`importScripts("${r.mainWorker}");`],{type:"text/javascript"})),s=new Worker(n),i=e?new H.ConsoleLogger:new H.VoidLogger,c=new H.AsyncDuckDB(i,s);return await c.instantiate(r.mainModule,r.pthreadWorker),URL.revokeObjectURL(n),c}function rt(e,t,{source:r,clients:n=(r?new Set([r]):void 0)}){return{meta:{type:"point"},source:r,clients:n,value:t,predicate:void 0!==t?z(e,[B(t)]):null}}function nt(e,t,{source:r,clients:n=(r?new Set([r]):void 0)}){let s=null;if(t){const r=t.length&&1===e.length?[z(e[0],t.map((e=>B(e[0]))))]:t.map((t=>m(t.map(((t,r)=>D(e[r],B(t)))))));s=0===t.length?B(!1):r.length>1?U(r):r[0]}return{meta:{type:"point"},source:r,clients:n,value:t,predicate:s}}function st(e,t,{source:r,clients:n=(r?new Set([r]):void 0),bin:s,scale:i,pixelSize:c=1}){return{meta:{type:"interval",scales:i&&[i],bin:s,pixelSize:c},source:r,clients:n,value:t,predicate:null!=t?A(e,t):null}}function it(e,t,{source:r,clients:n=(r?new Set([r]):void 0),bin:s,scales:i=[],pixelSize:c=1}){const o=null!=t?m(e.map(((e,r)=>A(e,t[r])))):null;return{meta:{type:"interval",scales:i,bin:s,pixelSize:c},source:r,clients:n,value:t,predicate:o}}const ct={contains:G,prefix:F,suffix:Q,regexp:W};function ot(e,t,{source:r,clients:n,method:s="contains"}){return{meta:{type:"match",method:s},source:r,clients:n,value:t,predicate:t?(0,ct[s])(e,B(t)):null}}function ut(e){return"function"==typeof e?.getChild}function at(){const e=new Set;let t,r=new Promise((e=>t=e));return{pending(t){e.add(t)},ready:t=>(e.delete(t),0===e.size),resolve(){r=new Promise((e=>{t(),t=e}))},get promise(){return r}}}function lt(e){return ut(e)?function(e){const{numRows:t}=e;return{numRows:t,columns:e.toColumns()}}(e):function(e){const t=e.length;if("object"==typeof e[0]){const r=t?Object.keys(e[0]):[],n={};return r.length>0&&r.forEach((t=>{n[t]=e.map((e=>e[t]))})),{numRows:t,columns:n}}return{numRows:t,values:e}}(e)}export{Ge as Coordinator,V as MosaicClient,Ye as Param,Be as Priority,Xe as Selection,st as clauseInterval,it as clauseIntervals,ot as clauseMatch,rt as clausePoint,nt as clausePoints,De as coordinator,X as decodeIPC,We as distinct,ut as isArrowTable,He as isParam,Je as isSelection,qe as jsType,Te as queryFieldInfo,Ke as restConnector,Z as socketConnector,at as synchronizer,J as throttle,lt as toDataColumns,et as wasmConnector};export default null;
